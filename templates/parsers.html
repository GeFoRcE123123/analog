{% extends 'base.html' %}
{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800">Статусы и управление парсерами</h1>
        <div class="space-x-2">
            <a href="#" onclick="refreshParsersStatus(); return false;" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                <i class="fas fa-rotate mr-2"></i>Обновить статусы
            </a>
        </div>
    </div>

    <div id="parsersStatus" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
function statusPill(text, color) {
    const colors = {
        green: 'bg-green-100 text-green-800',
        red: 'bg-red-100 text-red-800',
        yellow: 'bg-yellow-100 text-yellow-800',
        gray: 'bg-gray-100 text-gray-800',
        blue: 'bg-blue-100 text-blue-800'
    };
    return `<span class="px-2 py-1 rounded-full text-xs ${colors[color]||colors.gray}">${text}</span>`;
}

function renderParsers(parsers){
    const container = document.getElementById('parsersStatus');
    const cards = [];

    // OSV
    const osv = parsers.osv || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">OSV парсер</div>
            ${statusPill(osv.status || 'ready', (osv.status==='error'?'red':'green'))}
        </div>
        <div class="text-sm text-gray-600 space-y-1">
            <div>Макс. страниц: <b>${osv.max_pages ?? '-'}</b></div>
            <div>Всего в системе: <b>${osv.total_in_system ?? '-'}</b></div>
            <div>Последний запуск: <b>${osv.last_updated || '-'}</b></div>
            <div>Обработано всего: <b>${osv.total_processed ?? '-'}</b></div>
        </div>
        <div class="mt-3 flex space-x-2">
            <button onclick="window.startGlobalParsing()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">Запустить OSV</button>
        </div>
    </div>`);

    // NVD
    const nvd = parsers.nvd || {};
    const nvdService = nvd.service_status || {};
    const nvdConn = nvd.connection_status || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">NVD интеграция</div>
            ${statusPill(nvdService.status || 'unknown', (nvdService.status==='error'?'red':'green'))}
        </div>
        <div class="text-sm text-gray-600 space-y-1">
            <div>Соединение: ${statusPill(nvdConn.status || 'unknown', (nvdConn.status==='error'?'red':'green'))}</div>
            <div>Сообщение: <b>${(nvdConn.message || nvdService.message || '-') }</b></div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="quickNvdIncremental()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">NVD инкрементальная (1 день)</button>
            <button onclick="quickNvdFull()" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">NVD полная</button>
        </div>
    </div>`);

    // Red Hat
    const redhat = parsers.redhat || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">Red Hat CVE Importer</div>
            ${statusPill(redhat.available ? 'available' : 'unavailable', redhat.available ? 'green' : 'red')}
        </div>
        <div class="text-sm text-gray-600 space-y-1">
            <div>Последний запуск: <b>${redhat.last_run || '-'}</b></div>
            <div>Примечание: <b>${redhat.notes || '-'}</b></div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="quickRedHatRecent()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">Импорт последних 7 дней</button>
        </div>
    </div>`);

    // Scheduler
    const scheduler = parsers.scheduler || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">Планировщик</div>
            ${statusPill(scheduler.is_running ? 'running' : 'stopped', scheduler.is_running ? 'green' : 'red')}
        </div>
        <div class="text-sm text-gray-600">Состояние: <b>${scheduler.is_running ? 'Активен' : 'Остановлен'}</b></div>
        <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="schedulerStartHourly()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">Старт каждый час</button>
            <button onclick="schedulerStartDaily()" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">Старт ежедневно 02:00</button>
            <button onclick="schedulerStop()" class="px-3 py-2 bg-gray-600 text-white rounded-lg text-sm hover:bg-gray-700">Остановить</button>
        </div>
    </div>`);

    container.innerHTML = cards.join('');
}

function refreshParsersStatus(){
    fetch('/api/parsers/status')
        .then(r=>r.json())
        .then(data => {
            if (data.success) {
                renderParsers(data.parsers || {});
            } else {
                showNotification('Ошибка загрузки статусов', 'error');
            }
        })
        .catch(() => showNotification('Ошибка сети при загрузке статусов', 'error'));
}

document.addEventListener('DOMContentLoaded', refreshParsersStatus);
</script>
{% endblock %}


