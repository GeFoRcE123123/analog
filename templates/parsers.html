{% extends 'base.html' %}
{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800">–°—Ç–∞—Ç—É—Å—ã –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞–º–∏</h1>
        <div class="space-x-2">
            <a href="#" onclick="refreshParsersStatus(); return false;" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                <i class="fas fa-rotate mr-2"></i>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã
            </a>
            <a href="#" onclick="location.reload(); return false;" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                <i class="fas fa-sync mr-2"></i>–ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            </a>
        </div>
    </div>
    
    <!-- HTML Parser Section -->
    <div class="bg-white rounded-xl shadow border border-purple-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-800">HTML-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä</h2>
            <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">–ù–æ–≤—ã–π</span>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Parsing Controls -->
            <div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="html-source-checkbox rounded" value="ubuntu" checked>
                            <span class="ml-2 text-gray-700">Ubuntu Security</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="html-source-checkbox rounded" value="debian" checked>
                            <span class="ml-2 text-gray-700">Debian Security Tracker</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="html-source-checkbox rounded" value="nvd">
                            <span class="ml-2 text-gray-700">NVD (National Vulnerability Database)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="html-source-checkbox rounded" value="redhat">
                            <span class="ml-2 text-gray-700">Red Hat Security</span>
                        </label>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–õ–∏–º–∏—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π</label>
                    <input type="number" id="htmlParseLimit" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="10" min="1" max="100">
                </div>
                
                <button onclick="startHTMLParsing()" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center justify-center">
                    <i class="fas fa-spider mr-2"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å HTML-–ø–∞—Ä—Å–∏–Ω–≥
                </button>
            </div>
            
            <!-- Parsing Results -->
            <div>
                <h3 class="text-lg font-medium text-gray-800 mb-3">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞</h3>
                <div id="htmlParsingResults" class="bg-gray-50 rounded-lg p-4 min-h-[150px]">
                    <p class="text-gray-500 text-center py-8">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                </div>
            </div>
        </div>
        
        <!-- Real-time Parsing Information -->
        <div id="htmlParsingLiveInfo" class="mt-6 hidden">
            <h3 class="text-lg font-medium text-gray-800 mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–∞—Ä—Å–∏–Ω–≥–∞</h3>
            <div id="htmlParsingLiveContent" class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-y-auto">
                <p class="text-gray-500 text-center">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞...</p>
            </div>
        </div>
    </div>
    
    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="summaryStats" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow border border-blue-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-800 mb-3">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ë–î</h2>
                <div id="summaryContent" class="text-sm text-gray-600">
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</div>
                <div id="lastUpdated" class="text-sm font-medium text-gray-700">-</div>
            </div>
        </div>
    </div>

    <div id="parsersStatus" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
function statusPill(text, color) {
    const colors = {
        green: 'bg-green-100 text-green-800',
        red: 'bg-red-100 text-red-800',
        yellow: 'bg-yellow-100 text-yellow-800',
        gray: 'bg-gray-100 text-gray-800',
        blue: 'bg-blue-100 text-blue-800'
    };
    return `<span class="px-2 py-1 rounded-full text-xs ${colors[color]||colors.gray}">${text}</span>`;
}

function renderParsers(parsers){
    console.log('Rendering parsers:', parsers);
    const container = document.getElementById('parsersStatus');
    const cards = [];

    // OSV
    const osv = parsers.osv || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">OSV –ø–∞—Ä—Å–µ—Ä</div>
            ${statusPill(osv.status || 'ready', (osv.status==='error'?'red':'green'))}
        </div>
        <div class="text-sm text-gray-600 space-y-1">
            <div>–í –ë–î: <b>${osv.total_in_db ?? 0}</b> —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π <span class="text-blue-600">(${osv.percentage ?? 0}%)</span></div>
            <div>–ú–∞–∫—Å. —Å—Ç—Ä–∞–Ω–∏—Ü: <b>${osv.max_pages ?? '-'}</b></div>
            <div>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫: <b>${osv.last_updated || '-'}</b></div>
            <div>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: <b>${osv.total_processed ?? 0}</b></div>
        </div>
        <div class="mt-3 flex space-x-2">
            <button onclick="window.startGlobalParsing()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">–ó–∞–ø—É—Å—Ç–∏—Ç—å OSV</button>
        </div>
    </div>`);

    // NVD
    const nvd = parsers.nvd || {};
    const nvdService = nvd.service_status || {};
    const nvdConn = nvd.connection_status || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">NVD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</div>
            ${statusPill(nvdService.status || 'unknown', (nvdService.status==='error'?'red':'green'))}
        </div>
        <div class="text-sm text-gray-600 space-y-1">
            <div>–í –ë–î: <b>${nvdService.total_in_db ?? 0}</b> CVE <span class="text-blue-600">(${nvdService.percentage ?? 0}%)</span></div>
            <div>–ó–∞ –Ω–µ–¥–µ–ª—é: <b class="text-green-600">${nvdService.recent_week ?? 0}</b> –Ω–æ–≤—ã—Ö</div>
            <div>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${statusPill(nvdConn.status || 'unknown', (nvdConn.status==='error'?'red':'green'))}</div>
            <div>–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: <b>${nvdService.last_sync || '-'}</b></div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="quickNvdIncremental()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">NVD –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è (1 –¥–µ–Ω—å)</button>
            <button onclick="quickNvdFull()" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">NVD –ø–æ–ª–Ω–∞—è</button>
        </div>
    </div>`);

    // Red Hat
    const redhat = parsers.redhat || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">Red Hat CVE Importer</div>
            ${statusPill(redhat.available ? 'available' : 'unavailable', redhat.available ? 'green' : 'red')}
        </div>
        <div class="text-sm text-gray-600 space-y-1">
            <div>–í –ë–î: <b>${redhat.total_in_db ?? 0}</b> CVE <span class="text-blue-600">(${redhat.percentage ?? 0}%)</span></div>
            <div>–í—ã—Å–æ–∫–∞—è –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å: <b class="text-red-600">${redhat.high_severity_count ?? 0}</b></div>
            <div>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∏–º–ø–æ—Ä—Ç: <b>${redhat.last_import || '-'}</b></div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="quickRedHatRecent()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">–ò–º–ø–æ—Ä—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7 –¥–Ω–µ–π</button>
        </div>
    </div>`);
    
    // Ubuntu Security
    const ubuntu = parsers.ubuntu || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">Ubuntu Security</div>
            ${statusPill(ubuntu.available ? 'API' : 'unavailable', ubuntu.available ? 'blue' : 'red')}
        </div>
        <div class="text-sm text-gray-600 space-y-1">
            <div>–í –ë–î: <b>${ubuntu.total_in_db ?? 0}</b> —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π <span class="text-blue-600">(${ubuntu.percentage ?? 0}%)</span></div>
            <div>–¢–∏–ø: <b>${ubuntu.type || 'API'}</b></div>
            <div>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∏–º–ø–æ—Ä—Ç: <b>${ubuntu.last_import || '–Ω–∏–∫–æ–≥–¥–∞'}</b></div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="quickVendorParse(['ubuntu'])" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">–ü–∞—Ä—Å–∏—Ç—å Ubuntu (50)</button>
        </div>
    </div>`);
    
    // Debian Security
    const debian = parsers.debian || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">Debian Security Tracker</div>
            ${statusPill(debian.available ? 'API' : 'unavailable', debian.available ? 'blue' : 'red')}
        </div>
        <div class="text-sm text-gray-600 space-y-1">
            <div>–í –ë–î: <b>${debian.total_in_db ?? 0}</b> —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π <span class="text-blue-600">(${debian.percentage ?? 0}%)</span></div>
            <div>–¢–∏–ø: <b>${debian.type || 'API'}</b></div>
            <div>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∏–º–ø–æ—Ä—Ç: <b>${debian.last_import || '–Ω–∏–∫–æ–≥–¥–∞'}</b></div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="quickVendorParse(['debian'])" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">–ü–∞—Ä—Å–∏—Ç—å Debian (50)</button>
        </div>
    </div>`);
    
    // AI Tagger
    const aiTagger = parsers.ai_tagger || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">AI Tagger Service</div>
            ${statusPill(aiTagger.available ? 'active' : 'unavailable', aiTagger.available ? 'green' : 'red')}
        </div>
        <div class="text-sm text-gray-600 space-y-1">
            <div>AI —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π: <b class="text-purple-600">${aiTagger.ai_vulnerabilities ?? 0}</b> <span class="text-blue-600">(${aiTagger.percentage ?? 0}%)</span></div>
            <div>–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: <b>${aiTagger.avg_confidence ?? 0}%</b></div>
            <div>–í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (>70%): <b class="text-green-600">${aiTagger.high_confidence_count ?? 0}</b></div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
            <<button onclick="quickAITaggerScan()" class="px-3 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (100)</button>
        </div>
    </div>`);
    
    // Universal Vendor Parser
    const vendorParser = parsers.vendor_parser || {};
    const breakdown = vendorParser.breakdown || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">Universal Vendor Parser</div>
            ${statusPill(vendorParser.available ? `${vendorParser.sources_count || 9} sources` : 'unavailable', vendorParser.available ? 'green' : 'red')}
        </div>
        <div class="text-sm text-gray-600 space-y-1">
            <div>–í—Å–µ–≥–æ —Å–ø–∞—Ä—Å–µ–Ω–æ: <b class="text-green-600">${vendorParser.total_parsed ?? 0}</b></div>
            <div class="ml-4 text-xs">‚Ä¢ Ubuntu: <b>${breakdown.ubuntu ?? 0}</b>, Debian: <b>${breakdown.debian ?? 0}</b></div>
            <div>–ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ: <b>${vendorParser.sources_count || '-'}</b></div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="quickVendorParse(['ubuntu','debian'])" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">–ü–∞—Ä—Å–∏—Ç—å –≤—Å–µ API –∏—Å—Ç–æ—á–Ω–∏–∫–∏</button>
            <button onclick="quickHTMLParse(['ubuntu','debian'])" class="px-3 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700">HTML-–ø–∞—Ä—Å–∏–Ω–≥</button>
        </div>
    </div>`);

    // Scheduler
    const scheduler = parsers.scheduler || {};
    cards.push(`
    <div class="bg-white rounded-xl shadow border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-gray-800">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</div>
            ${statusPill(scheduler.is_running ? 'running' : 'stopped', scheduler.is_running ? 'green' : 'red')}
        </div>
        <div class="text-sm text-gray-600">–°–æ—Å—Ç–æ—è–Ω–∏–µ: <b>${scheduler.is_running ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}</b></div>
        <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="schedulerStartHourly()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">–°—Ç–∞—Ä—Ç –∫–∞–∂–¥—ã–π —á–∞—Å</button>
            <button onclick="schedulerStartDaily()" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">–°—Ç–∞—Ä—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ 02:00</button>
            <button onclick="schedulerStop()" class="px-3 py-2 bg-gray-600 text-white rounded-lg text-sm hover:bg-gray-700">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </div>`);

    container.innerHTML = cards.join('');
}

function refreshParsersStatus(){
    console.log('Refreshing parser status...');
    fetch('/api/parsers/status')
        .then(r=>r.json())
        .then(data => {
            console.log('Received parser status data:', data);
            if (data.success) {
                renderParsers(data.parsers || {});
                renderSummary(data.summary || {});
                console.log('Parser status refreshed successfully');
            } else {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        })
        .catch(error => {
            console.error('Error refreshing parser status:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç—É—Å–æ–≤: ' + error.message, 'error');
        });
}

function renderSummary(summary) {
    console.log('Rendering summary:', summary);
    const total = summary.total_vulnerabilities || 0;
    const bySource = summary.by_source || {};
    const aiRelated = summary.ai_related || 0;
    const lastUpdated = summary.last_updated || '-';
    
    const summaryHTML = `
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">${total.toLocaleString()}</div>
                <div class="text-xs text-gray-600">–í—Å–µ–≥–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600">${(bySource.osv || 0).toLocaleString()}</div>
                <div class="text-xs text-gray-600">OSV</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-indigo-600">${(bySource.nvd || 0).toLocaleString()}</div>
                <div class="text-xs text-gray-600">NVD</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600">${(bySource.redhat || 0).toLocaleString()}</div>
                <div class="text-xs text-gray-600">Red Hat</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-yellow-600">${((bySource.ubuntu || 0) + (bySource.debian || 0)).toLocaleString()}</div>
                <div class="text-xs text-gray-600">Linux Distros</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600">${aiRelated.toLocaleString()}</div>
                <div class="text-xs text-gray-600">AI-—É—è–∑–≤–∏–º–æ—Å—Ç–∏</div>
            </div>
        </div>
    `;
    
    document.getElementById('summaryContent').innerHTML = summaryHTML;
    document.getElementById('lastUpdated').textContent = lastUpdated;
}

// Quick actions for parsers
function quickVendorParse(sources) {
    showNotification(`–ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ ${sources.join(', ')}...`, 'info');
    fetch('/api/vendors/parse', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sources: sources, limit: 50})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification(`–£—Å–ø–µ—à–Ω–æ! –°–ø–∞—Ä—Å–µ–Ω–æ: ${data.total_parsed} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π`, 'success');
            setTimeout(refreshParsersStatus, 1000);
        } else {
            showNotification(`–û—à–∏–±–∫–∞: ${data.message}`, 'error');
        }
    })
    .catch(e => showNotification(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`, 'error'));
}

function quickAITaggerScan() {
    showNotification('–ó–∞–ø—É—Å–∫ AI Tagger —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...', 'info');
    fetch('/api/ai-tagger/scan-all', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification(`AI Tagger: –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ ${data.scanned}, AI –Ω–∞–π–¥–µ–Ω–æ: ${data.ai_found}`, 'success');
            setTimeout(refreshParsersStatus, 1000);
        } else {
            showNotification(`–û—à–∏–±–∫–∞: ${data.message}`, 'error');
        }
    })
    .catch(e => showNotification(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`, 'error'));
}

function quickRedHatRecent() {
    showNotification('–ó–∞–ø—É—Å–∫ Red Hat –∏–º–ø–æ—Ä—Ç–∞...', 'info');
    fetch('/api/redhat/import', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({recent_days: 7})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const result = data.result || {};
            const saved = result.successfully_saved || 0;
            showNotification(`Red Hat: –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${saved} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π`, 'success');
            setTimeout(refreshParsersStatus, 1000);
        } else {
            showNotification(`–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
        }
    })
    .catch(e => showNotification(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`, 'error'));
}

function quickHTMLParse(sources) {
    showNotification('–ó–∞–ø—É—Å–∫ HTML-–ø–∞—Ä—Å–∏–Ω–≥–∞...', 'info');
    fetch('/api/html-parser/parse', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sources: sources, limit: 50})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification(`HTML-–ø–∞—Ä—Å–µ—Ä: –°–ø–∞—Ä—Å–µ–Ω–æ ${data.total_parsed}, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${data.total_saved} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π`, 'success');
            setTimeout(refreshParsersStatus, 1000);
        } else {
            showNotification(`–û—à–∏–±–∫–∞ HTML-–ø–∞—Ä—Å–µ—Ä–∞: ${data.message}`, 'error');
        }
    })
    .catch(e => showNotification(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`, 'error'));
}

function startHTMLParsing() {
    // Get selected sources
    const selectedSources = [];
    document.querySelectorAll('.html-source-checkbox:checked').forEach(checkbox => {
        selectedSources.push(checkbox.value);
    });
    
    if (selectedSources.length === 0) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫', 'warning');
        return;
    }
    
    const limit = parseInt(document.getElementById('htmlParseLimit').value) || 10;
    
    // Show live parsing info section
    document.getElementById('htmlParsingLiveInfo').classList.remove('hidden');
    document.getElementById('htmlParsingLiveContent').innerHTML = '<p class="text-purple-600">üöÄ –ó–∞–ø—É—Å–∫ HTML-–ø–∞—Ä—Å–∏–Ω–≥–∞...</p>';
    
    // Update results section
    document.getElementById('htmlParsingResults').innerHTML = `
        <div class="flex items-center justify-center py-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
            <span class="ml-3 text-gray-600">–ü–∞—Ä—Å–∏–Ω–≥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...</span>
        </div>
    `;
    
    showNotification(`–ó–∞–ø—É—Å–∫ HTML-–ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–ª—è ${selectedSources.join(', ')} (–ª–∏–º–∏—Ç: ${limit})`, 'info');
    
    fetch('/api/html-parser/parse', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sources: selectedSources, limit: limit})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Update results display
            const resultsHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">–í—Å–µ–≥–æ —Å–ø–∞—Ä—Å–µ–Ω–æ:</span>
                        <span class="font-semibold text-purple-600">${data.total_parsed}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î:</span>
                        <span class="font-semibold text-green-600">${data.total_saved}</span>
                    </div>
                    <div class="pt-2 border-t border-gray-200">
                        <span class="text-gray-600">–ü–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º:</span>
                        <div class="mt-2 space-y-1">
                            ${Object.entries(data.by_source).map(([source, count]) => 
                                `<div class="flex justify-between text-sm">
                                    <span class="capitalize">${source}:</span>
                                    <span class="font-medium">${count}</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    ${data.errors && data.errors.length > 0 ? `
                    <div class="pt-2 border-t border-gray-200">
                        <span class="text-red-600">–û—à–∏–±–∫–∏: ${data.errors.length}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('htmlParsingResults').innerHTML = resultsHTML;
            
            showNotification(`HTML-–ø–∞—Ä—Å–µ—Ä: –°–ø–∞—Ä—Å–µ–Ω–æ ${data.total_parsed}, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${data.total_saved} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π`, 'success');
            setTimeout(refreshParsersStatus, 1000);
        } else {
            document.getElementById('htmlParsingResults').innerHTML = `
                <div class="text-center py-4 text-red-600">
                    <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                    <p>–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞</p>
                    <p class="text-sm mt-1">${data.message}</p>
                </div>
            `;
            showNotification(`–û—à–∏–±–∫–∞ HTML-–ø–∞—Ä—Å–µ—Ä–∞: ${data.message}`, 'error');
        }
    })
    .catch(e => {
        document.getElementById('htmlParsingResults').innerHTML = `
            <div class="text-center py-4 text-red-600">
                <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                <p>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>
                <p class="text-sm mt-1">${e.message}</p>
            </div>
        `;
        showNotification(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`, 'error');
    });
}

function showNotification(message, type) {
    // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
    };
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

document.addEventListener('DOMContentLoaded', refreshParsersStatus);
</script>
{% endblock %}


