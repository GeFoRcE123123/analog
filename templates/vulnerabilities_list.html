{% extends "base.html" %}

{% block content %}
<div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-800">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç—è–º–∏</h2>
        <p class="text-sm text-gray-600 mt-1">–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ</p>
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200">
                <div class="text-center">
                    <p class="text-2xl font-bold text-blue-600">{{ vulnerabilities|length }}</p>
                    <p class="text-sm text-gray-600">–í—Å–µ–≥–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π</p>
                </div>
            </div>
            <div class="bg-gradient-to-r from-red-50 to-red-100 rounded-xl p-4 border border-red-200">
                <div class="text-center">
                    <p class="text-2xl font-bold text-red-600">{{ vulnerabilities|selectattr('severity', 'equalto', 'high')|list|length + vulnerabilities|selectattr('severity', 'equalto', 'critical')|list|length }}</p>
                    <p class="text-sm text-gray-600">–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫</p>
                </div>
            </div>
            <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-xl p-4 border border-yellow-200">
                <div class="text-center">
                    <p class="text-2xl font-bold text-yellow-600">{{ vulnerabilities|selectattr('status', 'equalto', 'new')|list|length }}</p>
                    <p class="text-sm text-gray-600">–ù–æ–≤—ã–µ</p>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-4 border border-green-200">
                <div class="text-center">
                    <p class="text-2xl font-bold text-green-600">{{ vulnerabilities|selectattr('status', 'equalto', 'completed')|list|length + vulnerabilities|selectattr('status', 'equalto', 'approved')|list|length }}</p>
                    <p class="text-sm text-gray-600">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</p>
                </div>
            </div>
        </div>



        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl p-6 mb-8 shadow-sm">
            <div class="flex flex-wrap gap-6 items-end">
                <div class="flex-1 min-w-64">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üîç –ü–æ–∏—Å–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π</label>
                    <div class="relative">
                        <input type="text" id="search-filter" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏..."
                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üìä –°—Ç–∞—Ç—É—Å</label>
                    <select id="status-filter" class="w-48 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="new">üÜï –ù–æ–≤—ã–µ</option>
                        <option value="in_progress">üîÑ –í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="completed">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                        <option value="approved">üëç –û–¥–æ–±—Ä–µ–Ω–æ</option>
                        <option value="needs_modification">üìù –ù–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">‚ö†Ô∏è –£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞</label>
                    <select id="severity-filter" class="w-48 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <option value="all">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
                        <option value="critical">üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
                        <option value="high">üü† –í—ã—Å–æ–∫–∏–π</option>
                        <option value="medium">üü° –°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π -->
        <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">–£—Ä–æ–≤–µ–Ω—å</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">–°—Ç–∞—Ç—É—Å</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">CVSS</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="vulnerabilities-table-body">
                        {% for vulnerability in vulnerabilities %}
                        <tr class="hover:bg-blue-50 transition-all duration-200 vulnerability-row group"
                            data-status="{{ vulnerability.status }}"
                            data-severity="{{ vulnerability.severity }}"
                            data-title="{{ vulnerability.title|lower }}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-bug text-white text-sm"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm font-semibold text-gray-900 group-hover:text-blue-700 transition-colors">{{ vulnerability.title }}</div>
                                        <div class="text-xs text-gray-500">{{ vulnerability.category|title }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-600 max-w-md line-clamp-2 leading-relaxed">{{ vulnerability.description }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold severity-{{ vulnerability.severity }} shadow-sm">
                                    {% if vulnerability.severity == 'critical' %}üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                                    {% elif vulnerability.severity == 'high' %}üü† –í—ã—Å–æ–∫–∏–π
                                    {% elif vulnerability.severity == 'medium' %}üü° –°—Ä–µ–¥–Ω–∏–π
                                    {% else %}üü¢ –ù–∏–∑–∫–∏–π{% endif %}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold status-{{ vulnerability.status }} shadow-sm">
                                    {% if vulnerability.status == 'new' %}üÜï –ù–æ–≤—ã–π
                                    {% elif vulnerability.status == 'in_progress' %}üîÑ –í —Ä–∞–±–æ—Ç–µ
                                    {% elif vulnerability.status == 'completed' %}‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
                                    {% elif vulnerability.status == 'approved' %}üëç –û–¥–æ–±—Ä–µ–Ω–æ
                                    {% else %}üìù –ù–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏{% endif %}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <span class="text-lg font-bold {% if vulnerability.cvss_score >= 9 %}text-red-600{% elif vulnerability.cvss_score >= 7 %}text-orange-600{% elif vulnerability.cvss_score >= 4 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                        {{ "%.1f"|format(vulnerability.cvss_score) }}
                                    </span>
                                    <span class="text-xs text-gray-500 ml-1">/10</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                {% if vulnerability.assigned_operator %}
                                    {% set operator = operators|selectattr('id', 'equalto', vulnerability.assigned_operator)|first %}
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-8 w-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center mr-2">
                                            <span class="text-white text-xs font-semibold">{{ operator.name.split(' ')[0][0] }}{{ operator.name.split(' ')[1][0] if operator.name.split(' ')|length > 1 else operator.name[0] }}</span>
                                        </div>
                                        <div>
                                            <div class="font-medium text-gray-900">{{ operator.name }}</div>
                                            <div class="text-xs text-gray-500">{{ operator.email }}</div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="flex items-center text-gray-400">
                                        <i class="fas fa-user-slash mr-2"></i>
                                        <span>–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                    </div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <button onclick="showVulnerabilityDetails({{ vulnerability.id }})"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-xs font-medium rounded-lg text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 transform hover:scale-105"
                                            title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏">
                                        <i class="fas fa-eye mr-1"></i>
                                        –ü—Ä–æ—Å–º–æ—Ç—Ä
                                    </button>
                                    <button onclick="editVulnerability({{ vulnerability.id }})"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-xs font-medium rounded-lg text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 transform hover:scale-105"
                                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <i class="fas fa-edit mr-1"></i>
                                        –†–µ–¥–∞–∫—Ç.
                                    </button>
                                    {% if vulnerability.status == 'new' %}
                                    <button onclick="assignVulnerability({{ vulnerability.id }})"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-xs font-medium rounded-lg text-purple-700 bg-purple-100 hover:bg-purple-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200 transform hover:scale-105"
                                            title="–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞">
                                        <i class="fas fa-user-plus mr-1"></i>
                                        –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if not vulnerabilities %}
        <div class="text-center py-16">
            <div class="bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl p-8 inline-block">
                <i class="fas fa-search fa-4x text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">–£—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                <p class="text-gray-500 mb-4">–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.</p>
                <a href="{{ url_for('parsing_status') }}" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-xl text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 transform hover:scale-105">
                    <i class="fas fa-satellite-dish mr-2"></i>
                    –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ -->
<div id="view-modal" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <div class="relative top-10 mx-auto p-4 w-full max-w-4xl">
        <div class="bg-white rounded-2xl shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="view-modal-content">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white bg-opacity-20 p-2 rounded-xl">
                            <i class="fas fa-bug text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white" id="view-title">–ù–∞–∑–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏</h3>
                            <p class="text-blue-100 text-sm">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç–∏</p>
                        </div>
                    </div>
                    <button onclick="closeViewModal()" class="text-white hover:text-blue-200 transition-colors duration-200 p-2 rounded-lg hover:bg-white hover:bg-opacity-10">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="p-6 max-h-96 overflow-y-auto">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-xl p-4">
                            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                            </h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">–°—Ç–∞—Ç—É—Å:</span>
                                    <span id="view-status" class="font-medium"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:</span>
                                    <span id="view-risk-level" class="font-medium"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
                                    <span id="view-category" class="font-medium"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">CVSS Score:</span>
                                    <span id="view-cvss" class="font-bold text-lg"></span>
                                </div>
                            </div>
                        </div>

                        <!-- –î–µ—Ç–∞–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
                        <div class="bg-red-50 rounded-xl p-4">
                            <h4 class="font-semibold text-red-900 mb-3 flex items-center">
                                <i class="fas fa-shield-alt text-red-500 mr-2"></i>
                                –î–µ—Ç–∞–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                            </h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-red-700">–£—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏:</span>
                                    <span id="view-severity" class="font-semibold"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-red-700">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏:</span>
                                    <span id="view-modifications" class="font-semibold"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-red-700">–û–¥–æ–±—Ä–µ–Ω–∞:</span>
                                    <span id="view-approved" class="font-semibold"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                    <div class="space-y-4">
                        <!-- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ -->
                        <div class="bg-purple-50 rounded-xl p-4">
                            <h4 class="font-semibold text-purple-900 mb-3 flex items-center">
                                <i class="fas fa-user-tie text-purple-500 mr-2"></i>
                                –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
                            </h4>
                            <div id="view-assignment" class="space-y-2">
                                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                            </div>
                        </div>

                        <!-- –î–∞—Ç—ã -->
                        <div class="bg-green-50 rounded-xl p-4">
                            <h4 class="font-semibold text-green-900 mb-3 flex items-center">
                                <i class="fas fa-calendar-alt text-green-500 mr-2"></i>
                                –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
                            </h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-green-700">–°–æ–∑–¥–∞–Ω–∞:</span>
                                    <span id="view-created" class="font-medium text-sm"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-green-700">–ó–∞–≤–µ—Ä—à–µ–Ω–∞:</span>
                                    <span id="view-completed" class="font-medium text-sm"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –û–ø–∏—Å–∞–Ω–∏–µ (–∞–∫–∫–æ—Ä–¥–µ–æ–Ω) -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                    <button onclick="toggleDescription()" class="w-full px-6 py-4 text-left flex justify-between items-center hover:bg-blue-100 transition-colors duration-200 rounded-xl">
                        <h4 class="font-semibold text-blue-900 flex items-center">
                            <i class="fas fa-file-alt text-blue-500 mr-2"></i>
                            –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
                        </h4>
                        <i class="fas fa-chevron-down text-blue-500 transition-transform duration-200" id="description-chevron"></i>
                    </button>
                    <div id="description-content" class="px-6 pb-4 hidden">
                        <div class="bg-white rounded-lg p-4 border border-gray-200">
                            <p id="view-description" class="text-gray-700 leading-relaxed"></p>
                        </div>
                    </div>
                </div>

                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–∞–∫–∫–æ—Ä–¥–µ–æ–Ω) -->
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 mt-4">
                    <button onclick="toggleAdditionalInfo()" class="w-full px-6 py-4 text-left flex justify-between items-center hover:bg-gray-200 transition-colors duration-200 rounded-xl">
                        <h4 class="font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-database text-gray-500 mr-2"></i>
                            –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
                        </h4>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200" id="additional-info-chevron"></i>
                    </button>
                    <div id="additional-info-content" class="px-6 pb-4 hidden">
                        <div class="bg-white rounded-lg p-4 border border-gray-200 space-y-3">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium text-gray-600">ID —É—è–∑–≤–∏–º–æ—Å—Ç–∏:</span>
                                    <span id="view-id" class="text-gray-900 ml-2 font-mono"></span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-600">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</span>
                                    <span id="view-last-updated" class="text-gray-900 ml-2"></span>
                                </div>
                            </div>
                            <div class="border-t pt-3">
                                <span class="font-medium text-gray-600">–ú–µ—Ç—Ä–∏–∫–∏:</span>
                                <div class="mt-2 grid grid-cols-2 gap-2">
                                    <div class="bg-blue-50 rounded-lg p-2 text-center">
                                        <div class="text-xs text-blue-600">–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</div>
                                        <div class="font-bold text-blue-700" id="view-complexity">–°—Ä–µ–¥–Ω–∏–π</div>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-2 text-center">
                                        <div class="text-xs text-green-600">–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
                                        <div class="font-bold text-green-700" id="view-fix-time">2-4 –Ω–µ–¥–µ–ª–∏</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –§—É—Ç–µ—Ä -->
            <div class="bg-gray-50 rounded-b-2xl px-6 py-4 border-t border-gray-200">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="view-timestamp">–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ</span>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="closeViewModal()"
                                class="px-6 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200 transform hover:scale-105">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                        <button onclick="editCurrentVulnerability()"
                                class="px-6 py-2 text-sm font-medium text-white bg-gradient-to-r from-green-500 to-green-600 rounded-xl hover:from-green-600 hover:to-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-edit mr-2"></i>
                            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <div class="relative top-10 mx-auto p-4 w-full max-w-2xl">
        <div class="bg-white rounded-2xl shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="edit-modal-content">
            <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-t-2xl px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white bg-opacity-20 p-2 rounded-xl">
                            <i class="fas fa-edit text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏</h3>
                            <p class="text-green-100 text-sm">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —É—è–∑–≤–∏–º–æ—Å—Ç–∏</p>
                        </div>
                    </div>
                    <button onclick="closeEditModal()" class="text-white hover:text-green-200 transition-colors duration-200 p-2 rounded-lg hover:bg-white hover:bg-opacity-10">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <form id="edit-vulnerability-form" class="space-y-6 p-6 max-h-96 overflow-y-auto">
                <input type="hidden" id="edit-vuln-id" name="vulnerability_id">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-title" class="block text-sm font-semibold text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏</label>
                        <input type="text" id="edit-title" name="title"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                    </div>

                    <div>
                        <label for="edit-category" class="block text-sm font-semibold text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <input type="text" id="edit-category" name="category"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                    </div>
                </div>

                <div>
                    <label for="edit-description" class="block text-sm font-semibold text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="edit-description" name="description" rows="4"
                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-severity" class="block text-sm font-semibold text-gray-700 mb-2">–£—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏</label>
                        <select id="edit-severity" name="severity"
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                            <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                            <option value="medium">üü° –°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="high">üü† –í—ã—Å–æ–∫–∏–π</option>
                            <option value="critical">üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
                        </select>
                    </div>

                    <div>
                        <label for="edit-status" class="block text-sm font-semibold text-gray-700 mb-2">–°—Ç–∞—Ç—É—Å</label>
                        <select id="edit-status" name="status"
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                            <option value="new">üÜï –ù–æ–≤—ã–π</option>
                            <option value="in_progress">üîÑ –í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="completed">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                            <option value="approved">üëç –û–¥–æ–±—Ä–µ–Ω–æ</option>
                            <option value="needs_modification">üìù –¢—Ä–µ–±—É–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-cvss" class="block text-sm font-semibold text-gray-700 mb-2">CVSS Score</label>
                        <input type="number" id="edit-cvss" name="cvss_score" step="0.1" min="0" max="10"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                    </div>

                    <div>
                        <label for="edit-risk-level" class="block text-sm font-semibold text-gray-700 mb-2">–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞</label>
                        <select id="edit-risk-level" name="risk_level"
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                            <option value="low">–ù–∏–∑–∫–∏–π</option>
                            <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                            <option value="critical">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
                        </select>
                    </div>
                </div>
            </form>

            <div class="bg-gray-50 rounded-b-2xl px-6 py-4 border-t border-gray-200">
                <div class="flex justify-end space-x-4">
                    <button onclick="closeEditModal()"
                            class="px-6 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200 transform hover:scale-105">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button onclick="saveVulnerabilityChanges()"
                            class="px-6 py-3 text-sm font-medium text-white bg-gradient-to-r from-green-500 to-green-600 rounded-xl hover:from-green-600 hover:to-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ -->
<div id="assign-modal" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <div class="relative top-20 mx-auto p-4 w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="assign-modal-content">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-t-2xl px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white bg-opacity-20 p-2 rounded-xl">
                            <i class="fas fa-user-plus text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</h3>
                            <p class="text-purple-100 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</p>
                        </div>
                    </div>
                    <button onclick="closeAssignModal()" class="text-white hover:text-purple-200 transition-colors duration-200 p-2 rounded-lg hover:bg-white hover:bg-opacity-10">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <input type="hidden" id="assign-vuln-id">
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</label>
                    <select id="assign-operator-select" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ --</option>
                        {% for operator in operators %}
                        <option value="{{ operator.id }}">{{ operator.name }} ({{ operator.email }}) - {{ "%.1f"|format(operator.current_metric) }}%</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="bg-purple-50 rounded-xl p-4">
                    <h4 class="font-semibold text-purple-900 mb-2 flex items-center">
                        <i class="fas fa-info-circle text-purple-500 mr-2"></i>
                        –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    </h4>
                    <p class="text-purple-700 text-sm">–ü—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω–∏—Ç—Å—è –Ω–∞ "–í —Ä–∞–±–æ—Ç–µ"</p>
                </div>
            </div>

            <div class="bg-gray-50 rounded-b-2xl px-6 py-4 border-t border-gray-200">
                <div class="flex justify-end space-x-4">
                    <button onclick="closeAssignModal()"
                            class="px-6 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button onclick="confirmAssignment()"
                            class="px-6 py-3 text-sm font-medium text-white bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl hover:from-purple-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-check mr-2"></i>
                        –ù–∞–∑–Ω–∞—á–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notifications" class="fixed top-4 right-4 space-y-3 z-50"></div>

<style>
.severity-critical { @apply bg-red-100 text-red-800 border border-red-200; }
.severity-high { @apply bg-orange-100 text-orange-800 border border-orange-200; }
.severity-medium { @apply bg-yellow-100 text-yellow-800 border border-yellow-200; }
.severity-low { @apply bg-green-100 text-green-800 border border-green-200; }

.status-new { @apply bg-blue-100 text-blue-800 border border-blue-200; }
.status-in_progress { @apply bg-yellow-100 text-yellow-800 border border-yellow-200; }
.status-completed { @apply bg-green-100 text-green-800 border border-green-200; }
.status-approved { @apply bg-purple-100 text-purple-800 border border-purple-200; }
.status-needs_modification { @apply bg-red-100 text-red-800 border border-red-200; }

.vulnerability-row.hidden {
    display: none;
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
.modal-enter {
    animation: modalEnter 0.3s ease-out forwards;
}

@keyframes modalEnter {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}
</style>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentViewingVulnId = null;
let currentEditingVulnId = null;

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    const statusFilter = document.getElementById('status-filter');
    const severityFilter = document.getElementById('severity-filter');
    const searchFilter = document.getElementById('search-filter');

    function applyFilters() {
        const statusValue = statusFilter.value;
        const severityValue = severityFilter.value;
        const searchValue = searchFilter.value.toLowerCase();

        document.querySelectorAll('.vulnerability-row').forEach(row => {
            const status = row.getAttribute('data-status');
            const severity = row.getAttribute('data-severity');
            const title = row.getAttribute('data-title');

            const statusMatch = statusValue === 'all' || status === statusValue;
            const severityMatch = severityValue === 'all' || severity === severityValue;
            const searchMatch = title.includes(searchValue);

            if (statusMatch && severityMatch && searchMatch) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');
            }
        });
    }

    statusFilter.addEventListener('change', applyFilters);
    severityFilter.addEventListener('change', applyFilters);
    searchFilter.addEventListener('input', applyFilters);
});

function showVulnerabilityDetails(vulnId) {
    currentViewingVulnId = vulnId;
    console.log('Opening vulnerability details for ID:', vulnId);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
    fetch(`/get-vulnerability/${vulnId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Vulnerability data received:', data);
            if (data.success) {
                const vuln = data.vulnerability;
                populateViewModal(vuln);
                openViewModal();
            } else {
                console.error('Error in response:', data);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–∏', 'error');
            }
        })
        .catch(error => {
            console.error('Error fetching vulnerability:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–∏', 'error');
        });
}

function populateViewModal(vuln) {
    console.log('–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏:', vuln);
    console.log('üîç DEBUG populateViewModal - –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏:', vuln);
    console.log('üîç DEBUG - assigned_operator:', vuln.assigned_operator);
    console.log('üîç DEBUG - –¢–∏–ø assigned_operator:', typeof vuln.assigned_operator);

    // –ú–µ—Ç—Ä–∏–∫–∏
    document.getElementById('view-complexity').textContent = calculateComplexity(vuln);
    document.getElementById('view-fix-time').textContent = calculateFixTime(vuln);
    document.getElementById('view-timestamp').textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ';
    // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    document.getElementById('view-title').textContent = vuln.title || '–ù–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è';
    document.getElementById('view-description').textContent = vuln.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
    document.getElementById('view-status').innerHTML = getStatusBadge(vuln.status || 'new');
    document.getElementById('view-severity').innerHTML = getSeverityBadge(vuln.severity || 'medium');
    document.getElementById('view-risk-level').textContent = getRiskLevelText(vuln.risk_level || 'medium');
    document.getElementById('view-category').textContent = vuln.category || 'web';
    document.getElementById('view-cvss').textContent = vuln.cvss_score ? vuln.cvss_score.toFixed(1) : '0.0';
    document.getElementById('view-modifications').textContent = vuln.modifications || 0;
    document.getElementById('view-approved').textContent = vuln.approved ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç';
    document.getElementById('view-id').textContent = vuln.id || 'N/A';

    // –î–∞—Ç—ã
    const now = new Date();
    document.getElementById('view-created').textContent = vuln.created_date ?
        new Date(vuln.created_date).toLocaleString() : now.toLocaleString();
    document.getElementById('view-completed').textContent = vuln.completed_date ?
        new Date(vuln.completed_date).toLocaleString() : '–ù–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
    document.getElementById('view-last-updated').textContent = now.toLocaleString();

    // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ - –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º assigned_operator –∏–∑ –¥–∞–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–∏
    console.log('Assigned operator ID:', vuln.assigned_operator);
    loadOperatorAssignment(vuln.assigned_operator, vuln.id);

    // –ú–µ—Ç—Ä–∏–∫–∏ (—Ä–∞—Å—á–µ—Ç–Ω—ã–µ)
    document.getElementById('view-complexity').textContent = calculateComplexity(vuln);
    document.getElementById('view-fix-time').textContent = calculateFixTime(vuln);
    document.getElementById('view-timestamp').textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ';
}

function loadOperatorAssignment(operatorId, vulnId) {
    const assignmentDiv = document.getElementById('view-assignment');
    console.log('üîç DEBUG loadOperatorAssignment - operatorId:', operatorId, 'vulnId:', vulnId);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    assignmentDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-purple-500 text-2xl"></i><p class="text-purple-700 mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞...</p></div>';

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ operatorId
    if (operatorId && operatorId !== 0 && operatorId !== '0' && operatorId !== null && operatorId !== undefined) {
        console.log('üîç DEBUG - –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ /get-operator/' + operatorId);

        fetch(`/get-operator/${operatorId}`)
            .then(response => {
                console.log('üîç DEBUG - –û—Ç–≤–µ—Ç –æ—Ç /get-operator:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üîç DEBUG - –î–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ–ª—É—á–µ–Ω—ã:', data);

                if (data.success && data.operator) {
                    const operator = data.operator;
                    console.log('üîç DEBUG - –û–ø–µ—Ä–∞—Ç–æ—Ä –Ω–∞–π–¥–µ–Ω:', operator);

                    assignmentDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-white text-sm font-semibold">
                                        ${getInitials(operator.name)}
                                    </span>
                                </div>
                                <div>
                                    <div class="font-semibold text-purple-900">${operator.name}</div>
                                    <div class="text-xs text-purple-700">${operator.email}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-purple-900">${operator.current_metric}%</div>
                                <div class="text-xs text-purple-700">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                            </div>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button onclick="reassignOperator(${vulnId})"
                                    class="flex-1 px-3 py-1 text-xs font-medium text-purple-700 bg-purple-100 hover:bg-purple-200 rounded-lg transition-colors duration-200">
                                <i class="fas fa-sync-alt mr-1"></i>–ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç—å
                            </button>
                            <button onclick="unassignOperator(${vulnId})"
                                    class="flex-1 px-3 py-1 text-xs font-medium text-red-700 bg-red-100 hover:bg-red-200 rounded-lg transition-colors duration-200">
                                <i class="fas fa-times mr-1"></i>–°–Ω—è—Ç—å
                            </button>
                        </div>
                    `;
                } else {
                    console.error('üîç DEBUG - –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:', data);
                    showAssignmentNotAssigned(vulnId);
                }
            })
            .catch(error => {
                console.error('üîç DEBUG - –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:', error);
                assignmentDiv.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-2"></i>
                        <p class="text-red-700 font-medium">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</p>
                        <p class="text-red-600 text-sm">${error.message}</p>
                        <button onclick="loadOperatorAssignment(${operatorId}, ${vulnId})"
                                class="mt-2 px-4 py-2 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-lg transition-colors duration-200">
                            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
                        </button>
                    </div>
                `;
            });
    } else {
        console.log('üîç DEBUG - operatorId –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —Ä–∞–≤–µ–Ω 0/null');
        showAssignmentNotAssigned(vulnId);
    }
}

// –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
function testOperatorLoad(operatorId) {
    console.log('üß™ TEST: –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', operatorId);
    fetch(`/get-operator/${operatorId}`)
        .then(response => response.json())
        .then(data => {
            console.log('üß™ TEST: –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:', data);
            if (data.success) {
                alert(`‚úÖ –û–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω: ${data.operator.name} (${data.operator.email})`);
            } else {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('üß™ TEST: –û—à–∏–±–∫–∞:', error);
            alert(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
        });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–æ–≤
function getInitials(name) {
    if (!name) return '??';
    const parts = name.split(' ');
    if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
}



// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è "–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ"
function showAssignmentNotAssigned(vulnId) {
    const assignmentDiv = document.getElementById('view-assignment');
    assignmentDiv.innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-user-slash text-3xl text-purple-400 mb-2"></i>
            <p class="text-purple-700 font-medium">–û–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</p>
            <button onclick="assignCurrentVulnerability()"
                    class="mt-2 px-4 py-2 text-xs font-medium text-white bg-purple-500 hover:bg-purple-600 rounded-lg transition-colors duration-200">
                –ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
            </button>
        </div>
    `;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
function reassignOperator(vulnId) {
    closeViewModal();
    setTimeout(() => {
        assignVulnerability(vulnId);
    }, 350);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–Ω—è—Ç–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
function unassignOperator(vulnId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–Ω—è—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å —ç—Ç–æ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏?')) {
        fetch('/api/unassign-vulnerability', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                vulnerability_id: parseInt(vulnId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–Ω—è—Ç–æ', 'success');
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                if (currentViewingVulnId === vulnId) {
                    showVulnerabilityDetails(vulnId);
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification(data.message || '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è', 'error');
        });
    }
}


function getStatusBadge(status) {
    const badges = {
        'new': '<span class="status-new px-2 py-1 rounded-full text-xs font-semibold">üÜï –ù–æ–≤—ã–π</span>',
        'in_progress': '<span class="status-in_progress px-2 py-1 rounded-full text-xs font-semibold">üîÑ –í —Ä–∞–±–æ—Ç–µ</span>',
        'completed': '<span class="status-completed px-2 py-1 rounded-full text-xs font-semibold">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>',
        'approved': '<span class="status-approved px-2 py-1 rounded-full text-xs font-semibold">üëç –û–¥–æ–±—Ä–µ–Ω–æ</span>',
        'needs_modification': '<span class="status-needs_modification px-2 py-1 rounded-full text-xs font-semibold">üìù –ù–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏</span>'
    };
    return badges[status] || badges['new'];
}

function getSeverityBadge(severity) {
    const badges = {
        'critical': '<span class="severity-critical px-2 py-1 rounded-full text-xs font-semibold">üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</span>',
        'high': '<span class="severity-high px-2 py-1 rounded-full text-xs font-semibold">üü† –í—ã—Å–æ–∫–∏–π</span>',
        'medium': '<span class="severity-medium px-2 py-1 rounded-full text-xs font-semibold">üü° –°—Ä–µ–¥–Ω–∏–π</span>',
        'low': '<span class="severity-low px-2 py-1 rounded-full text-xs font-semibold">üü¢ –ù–∏–∑–∫–∏–π</span>'
    };
    return badges[severity] || badges['medium'];
}

function getRiskLevelText(riskLevel) {
    const texts = {
        'critical': 'üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π',
        'high': 'üü† –í—ã—Å–æ–∫–∏–π',
        'medium': 'üü° –°—Ä–µ–¥–Ω–∏–π',
        'low': 'üü¢ –ù–∏–∑–∫–∏–π'
    };
    return texts[riskLevel] || texts['medium'];
}

function calculateComplexity(vuln) {
    if (vuln.cvss_score >= 9) return '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è';
    if (vuln.cvss_score >= 7) return '–í—ã—Å–æ–∫–∞—è';
    if (vuln.cvss_score >= 4) return '–°—Ä–µ–¥–Ω—è—è';
    return '–ù–∏–∑–∫–∞—è';
}

function calculateFixTime(vuln) {
    if (vuln.cvss_score >= 9) return '4-6 –Ω–µ–¥–µ–ª—å';
    if (vuln.cvss_score >= 7) return '2-4 –Ω–µ–¥–µ–ª–∏';
    if (vuln.cvss_score >= 4) return '1-2 –Ω–µ–¥–µ–ª–∏';
    return '3-7 –¥–Ω–µ–π';
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–≤
function toggleDescription() {
    const content = document.getElementById('description-content');
    const chevron = document.getElementById('description-chevron');
    content.classList.toggle('hidden');
    chevron.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
}

function toggleAdditionalInfo() {
    const content = document.getElementById('additional-info-content');
    const chevron = document.getElementById('additional-info-chevron');
    content.classList.toggle('hidden');
    chevron.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
}

// –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
function openViewModal() {
    const modal = document.getElementById('view-modal');
    const content = document.getElementById('view-modal-content');
    modal.classList.remove('hidden');
    setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
    }, 10);
}

function closeViewModal() {
    const modal = document.getElementById('view-modal');
    const content = document.getElementById('view-modal-content');
    content.classList.add('scale-95', 'opacity-0');
    content.classList.remove('scale-100', 'opacity-100');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

function editVulnerability(vulnId) {
    currentEditingVulnId = vulnId;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
    fetch(`/get-vulnerability/${vulnId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const vuln = data.vulnerability;
                document.getElementById('edit-vuln-id').value = vuln.id;
                document.getElementById('edit-title').value = vuln.title;
                document.getElementById('edit-description').value = vuln.description;
                document.getElementById('edit-severity').value = vuln.severity;
                document.getElementById('edit-status').value = vuln.status;
                document.getElementById('edit-cvss').value = vuln.cvss_score;
                document.getElementById('edit-category').value = vuln.category;
                document.getElementById('edit-risk-level').value = vuln.risk_level;

                openEditModal();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–∏', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–∏', 'error');
        });
}

function openEditModal() {
    const modal = document.getElementById('edit-modal');
    const content = document.getElementById('edit-modal-content');
    modal.classList.remove('hidden');
    setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
    }, 10);
}

function closeEditModal() {
    const modal = document.getElementById('edit-modal');
    const content = document.getElementById('edit-modal-content');
    content.classList.add('scale-95', 'opacity-0');
    content.classList.remove('scale-100', 'opacity-100');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

function assignVulnerability(vulnId) {
    document.getElementById('assign-vuln-id').value = vulnId;
    openAssignModal();
}

function openAssignModal() {
    const modal = document.getElementById('assign-modal');
    const content = document.getElementById('assign-modal-content');

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
    loadOperatorsForAssignment();

    modal.classList.remove('hidden');
    setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
    }, 10);
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
function loadOperatorsForAssignment() {
    const select = document.getElementById('assign-operator-select');

    fetch('/api/operators')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û—á–∏—â–∞–µ–º select
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ --</option>';

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
                data.operators.forEach(operator => {
                    const option = document.createElement('option');
                    option.value = operator.id;
                    option.textContent = `${operator.name} (${operator.email}) - ${operator.current_metric}% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏`;
                    option.setAttribute('data-operator', JSON.stringify(operator));
                    select.appendChild(option);
                });

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞
                select.addEventListener('change', function() {
                    showOperatorInfo(this.value, JSON.parse(this.options[this.selectedIndex]?.getAttribute('data-operator') || '{}'));
                });
            } else {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading operators:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤', 'error');
        });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ
function showOperatorInfo(operatorId, operator) {
    const infoDiv = document.getElementById('operator-info');

    if (operatorId && operator.id) {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–≥—Ä—É–∑–∫—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        fetch(`/api/operator-workload/${operatorId}`)
            .then(response => response.json())
            .then(data => {
                const workload = data.success ? data.workload : 0;
                const recommendation = workload < 50 ? '‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω' : workload < 80 ? '‚ö†Ô∏è –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞' : '‚ùå –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞';

                document.getElementById('operator-metric').textContent = `${operator.current_metric}%`;
                document.getElementById('operator-experience').textContent = `${operator.experience_level}%`;
                document.getElementById('operator-workload').textContent = `${workload}%`;
                document.getElementById('operator-recommendation').textContent = recommendation;

                infoDiv.classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error loading workload:', error);
                infoDiv.classList.add('hidden');
            });
    } else {
        infoDiv.classList.add('hidden');
    }
}

function closeAssignModal() {
    const modal = document.getElementById('assign-modal');
    const content = document.getElementById('assign-modal-content');
    content.classList.add('scale-95', 'opacity-0');
    content.classList.remove('scale-100', 'opacity-100');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function editCurrentVulnerability() {
    closeViewModal();
    setTimeout(() => {
        editVulnerability(currentViewingVulnId);
    }, 350);
}

function assignCurrentVulnerability() {
    closeViewModal();
    setTimeout(() => {
        assignVulnerability(currentViewingVulnId);
    }, 350);
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (saveVulnerabilityChanges, confirmAssignment, showNotification) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
// ... (–æ–Ω–∏ —Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ)

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
window.onclick = function(event) {
    const viewModal = document.getElementById('view-modal');
    const editModal = document.getElementById('edit-modal');
    const assignModal = document.getElementById('assign-modal');

    if (event.target === viewModal) {
        closeViewModal();
    }
    if (event.target === editModal) {
        closeEditModal();
    }
    if (event.target === assignModal) {
        closeAssignModal();
    }
}


function saveVulnerabilityChanges() {
    const form = document.getElementById('edit-vulnerability-form');
    const formData = new FormData(form);
    const updates = {};

    for (let [key, value] of formData.entries()) {
        if (key !== 'vulnerability_id') {
            updates[key] = value;
        }
    }

    const vulnId = formData.get('vulnerability_id');

    fetch('/update-vulnerability', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            vulnerability_id: parseInt(vulnId),
            updates: updates
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('–£—è–∑–≤–∏–º–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            closeEditModal();
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏', 'error');
    });
}
function confirmAssignment() {
    const vulnId = document.getElementById('assign-vuln-id').value;
    const operatorId = document.getElementById('assign-operator-select').value;

    if (!operatorId) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞');
        return;
    }

    fetch('/api/assign-operator', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            vulnerability_id: parseInt(vulnId),
            operator_id: parseInt(operatorId)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('–û–ø–µ—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω', 'success');
            closeAssignModal();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', 'error');
    });
}
// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transform transition-transform duration-300 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    notification.style.zIndex = '1000';

    document.body.appendChild(notification);

    // –ê–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        notification.remove();
    }, 5000);
}




// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏
function saveVulnerabilityChanges() {
    const form = document.getElementById('edit-vulnerability-form');
    const formData = new FormData(form);
    const updates = {};

    for (let [key, value] of formData.entries()) {
        if (key !== 'vulnerability_id' && value !== '') {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
            if (key === 'cvss_score') {
                updates[key] = parseFloat(value);
            } else if (key === 'modifications') {
                updates[key] = parseInt(value);
            } else {
                updates[key] = value;
            }
        }
    }

    const vulnId = formData.get('vulnerability_id');

    if (Object.keys(updates).length === 0) {
        showNotification('‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'info');
        return;
    }

    fetch('/update-vulnerability', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            vulnerability_id: parseInt(vulnId),
            updates: updates
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –£—è–∑–≤–∏–º–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            closeEditModal();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏', 'error');
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
function confirmAssignment() {
    const vulnId = document.getElementById('assign-vuln-id').value;
    const operatorId = document.getElementById('assign-operator-select').value;

    if (!operatorId) {
        showNotification('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', 'error');
        return;
    }

    fetch('/api/assign-operator', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            vulnerability_id: parseInt(vulnId),
            operator_id: parseInt(operatorId)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –û–ø–µ—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω', 'success');
            closeAssignModal();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(data.message || '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', 'error');
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    const notifications = document.getElementById('notifications');
    const notification = document.createElement('div');

    const typeClasses = {
        'success': 'bg-gradient-to-r from-green-500 to-green-600 text-white border-l-4 border-green-400',
        'error': 'bg-gradient-to-r from-red-500 to-red-600 text-white border-l-4 border-red-400',
        'info': 'bg-gradient-to-r from-blue-500 to-blue-600 text-white border-l-4 border-blue-400'
    };

    const icons = {
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-circle',
        'info': 'fa-info-circle'
    };

    notification.className = `${typeClasses[type]} px-6 py-4 rounded-r-xl shadow-lg transform transition-all duration-300 translate-x-96`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${icons[type]} mr-3 text-lg"></i>
            <span class="font-medium">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    notifications.appendChild(notification);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
        notification.classList.remove('translate-x-96');
        notification.classList.add('translate-x-0');
    }, 10);

    // –ê–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        notification.classList.add('translate-x-96');
        notification.classList.remove('translate-x-0');
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 300);
    }, 5000);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeViewModal();
        closeEditModal();
        closeAssignModal();
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    console.log('Vulnerability Management System loaded');
});
</script>

{% endblock %}