<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vulnerability Management System</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom Styles -->
    <style>
        .nav-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .nav-shadow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .nav-item {
            position: relative;
            transition: all 0.3s ease;
        }
        .nav-item::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 2px;
            background: white;
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        .nav-item:hover::after {
            width: 100%;
        }
        .logo-glow {
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        .notification-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .import-btn-glow {
            animation: importGlow 3s infinite;
        }
        @keyframes importGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            }
            50% {
                box-shadow: 0 0 30px rgba(59, 130, 246, 0.8), 0 0 40px rgba(59, 130, 246, 0.6);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- –ù–û–í–ê–Ø –°–¢–ò–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <nav class="nav-gradient nav-shadow sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- –õ–æ–≥–æ—Ç–∏–ø –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ -->
                <div class="flex items-center space-x-4">
                    <div class="flex-shrink-0">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-shield-alt text-white text-2xl logo-glow"></i>
                            <span class="text-white font-bold text-xl">–ê–Ω–∞–ª–æ–≥</span>
                        </div>
                    </div>

                    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã -->
                    <div class="hidden md:flex items-center space-x-1 ml-8">
                        <a href="{{ url_for('dashboard') }}"
                           class="nav-item text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2 {% if request.path == '/' %}bg-white bg-opacity-20{% endif %}">
                            <i class="fas fa-chart-dashboard"></i>
                            <span>–î–∞—à–±–æ—Ä–¥</span>
                        </a>

                        <a href="{{ url_for('vulnerabilities_list') }}"
                           class="nav-item text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2 {% if request.path == '/vulnerabilities' %}bg-white bg-opacity-20{% endif %}">
                            <i class="fas fa-bug"></i>
                            <span>–£—è–∑–≤–∏–º–æ—Å—Ç–∏</span>
                            {% if vulnerabilities %}
                            <span class="bg-red-500 text-white text-xs rounded-full px-2 py-1 notification-badge">
                                {{ vulnerabilities|selectattr('status', 'equalto', 'new')|list|length }}
                            </span>
                            {% endif %}
                        </a>

                        <a href="{{ url_for('operators_page') }}"
                           class="nav-item text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2 {% if request.path == '/operators' %}bg-white bg-opacity-20{% endif %}">
                            <i class="fas fa-users"></i>
                            <span>–û–ø–µ—Ä–∞—Ç–æ—Ä—ã</span>
                        </a>

                        <a href="{{ url_for('performance_analytics') }}"
                           class="nav-item text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2 {% if request.path == '/performance' %}bg-white bg-opacity-20{% endif %}">
                            <i class="fas fa-chart-line"></i>
                            <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                        </a>

                        <a href="{{ url_for('review_vulnerabilities') }}"
                           class="nav-item text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2 {% if request.path == '/review' %}bg-white bg-opacity-20{% endif %}">
                            <i class="fas fa-check-double"></i>
                            <span>–ü—Ä–æ–≤–µ—Ä–∫–∞</span>
                        </a>
                    </div>
                </div>

                <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
                <div class="flex items-center space-x-4">
                    <!-- –ü—Ä–æ—Å—Ç–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–∞—Ä—Å–µ—Ä–æ–≤ -->
                    <a href="{{ url_for('parsers_page') }}" 
                       class="bg-white text-blue-600 hover:bg-blue-50 font-bold py-2 px-4 rounded-lg transition duration-300 import-btn-glow flex items-center space-x-2">
                        <i class="fas fa-download"></i>
                        <span>–ü–∞—Ä—Å–µ—Ä—ã</span>
                    </a>
                    <!-- –û—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ Excel –≤ –∑–µ–ª–µ–Ω–æ–º —Å—Ç–∏–ª–µ -->
                    <a href="{{ url_for('import_excel_page') }}" 
                       class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-file-excel"></i>
                        <span>–ò–º–ø–æ—Ä—Ç Excel</span>
                    </a>

                    <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é -->
                    <div class="md:hidden">
                        <button id="mobile-menu-button" class="text-white hover:text-gray-200">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="mobile-menu" class="md:hidden hidden bg-indigo-700">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="{{ url_for('dashboard') }}"
                   class="text-white block px-3 py-2 rounded-lg font-medium flex items-center space-x-2 {% if request.path == '/' %}bg-white bg-opacity-20{% endif %}">
                    <i class="fas fa-chart-dashboard w-5"></i>
                    <span>–î–∞—à–±–æ—Ä–¥</span>
                </a>

                <a href="{{ url_for('vulnerabilities_list') }}"
                   class="text-white block px-3 py-2 rounded-lg font-medium flex items-center space-x-2 {% if request.path == '/vulnerabilities' %}bg-white bg-opacity-20{% endif %}">
                    <i class="fas fa-bug w-5"></i>
                    <span>–£—è–∑–≤–∏–º–æ—Å—Ç–∏</span>
                    {% if vulnerabilities %}
                    <span class="bg-red-500 text-white text-xs rounded-full px-2 py-1">
                        {{ vulnerabilities|selectattr('status', 'equalto', 'new')|list|length }}
                    </span>
                    {% endif %}
                </a>

                <a href="{{ url_for('operators_page') }}"
                   class="text-white block px-3 py-2 rounded-lg font-medium flex items-center space-x-2 {% if request.path == '/operators' %}bg-white bg-opacity-20{% endif %}">
                    <i class="fas fa-users w-5"></i>
                    <span>–û–ø–µ—Ä–∞—Ç–æ—Ä—ã</span>
                </a>

                <a href="{{ url_for('performance_analytics') }}"
                   class="text-white block px-3 py-2 rounded-lg font-medium flex items-center space-x-2 {% if request.path == '/performance' %}bg-white bg-opacity-20{% endif %}">
                    <i class="fas fa-chart-line w-5"></i>
                    <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                </a>

                <a href="{{ url_for('review_vulnerabilities') }}"
                   class="text-white block px-3 py-2 rounded-lg font-medium flex items-center space-x-2 {% if request.path == '/review' %}bg-white bg-opacity-20{% endif %}">
                    <i class="fas fa-check-double w-5"></i>
                    <span>–ü—Ä–æ–≤–µ—Ä–∫–∞</span>
                </a>
                <a href="{{ url_for('import_excel_page') }}"
                   class="text-white block px-3 py-2 rounded-lg font-medium flex items-center space-x-2 {% if request.path == '/import-excel' %}bg-white bg-opacity-20{% endif %}">
                    <i class="fas fa-file-excel w-5"></i>
                    <span>–ò–º–ø–æ—Ä—Ç Excel</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Flash —Å–æ–æ–±—â–µ–Ω–∏—è -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6 space-y-2">
                    {% for category, message in messages %}
                        <div class="p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700 border border-red-300
                                           {% elif category == 'success' %}bg-green-100 text-green-700 border border-green-300
                                           {% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %}">
                            <div class="flex items-center">
                                <i class="fas {% if category == 'error' %}fa-exclamation-circle
                                            {% elif category == 'success' %}fa-check-circle
                                            {% else %}fa-info-circle{% endif %} mr-2"></i>
                                {{ message }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ (–±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤–µ–∑–¥–µ)
window.startGlobalParsing = function() {
    const statusElement = document.getElementById('parsingStatus');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('parsingProgress');
    const messageElement = document.getElementById('parsingMessage');

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if (!statusElement) {
        const newStatusElement = document.createElement('div');
        newStatusElement.id = 'parsingStatus';
        newStatusElement.className = 'fixed top-20 right-4 z-50 bg-blue-50 border border-blue-200 rounded-xl p-4 min-w-80';
        newStatusElement.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-blue-800">
                    <i class="fas fa-sync-alt fa-spin mr-2"></i>–ü–∞—Ä—Å–∏–Ω–≥ OSV
                </h3>
                <span id="parsingProgress" class="text-blue-600 font-medium">0%</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-2">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="parsingMessage" class="text-xs text-blue-600 mt-1">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</p>
        `;
        document.body.appendChild(newStatusElement);
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    document.getElementById('parsingStatus').classList.remove('hidden');

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥
    fetch('/api/start-parsing', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            trackGlobalParsingProgress();
        } else {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + data.error, 'error');
            document.getElementById('parsingStatus').classList.add('hidden');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞', 'error');
        document.getElementById('parsingStatus').classList.add('hidden');
    });
};

function trackGlobalParsingProgress() {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('parsingProgress');
    const messageElement = document.getElementById('parsingMessage');

    const eventSource = new EventSource('/api/parsing-progress');

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.progress !== undefined) {
            const progress = data.progress;
            if (progressBar) progressBar.style.width = progress + '%';
            if (progressText) progressText.textContent = progress + '%';
            if (messageElement) messageElement.textContent = data.message || '–ü–∞—Ä—Å–∏–Ω–≥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...';
        }

        if (data.status === 'completed') {
            if (messageElement) messageElement.textContent = '–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω! –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É...';
            if (progressBar) progressBar.style.width = '100%';
            if (progressText) progressText.textContent = '100%';

            setTimeout(() => {
                location.reload();
            }, 2000);

            eventSource.close();
        } else if (data.status === 'error') {
            if (messageElement) messageElement.textContent = '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + data.error;
            showNotification('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞', 'error');
            eventSource.close();

            setTimeout(() => {
                const statusEl = document.getElementById('parsingStatus');
                if (statusEl) statusEl.classList.add('hidden');
            }, 5000);
        }
    };

    eventSource.onerror = function(event) {
        console.error('EventSource failed:', event);
        eventSource.close();
    };
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-20 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-transform duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 5000);
}
</script>
    <script>
// –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø–∞—Ä—Å–µ—Ä–æ–≤
function quickNvdIncremental() {
    fetch('/api/nvd/sync/incremental', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ days: 1 })
    }).then(r=>r.json()).then(data=>{
        if (data.status === 'success') {
            showNotification('NVD –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞', 'success');
            setTimeout(refreshParsersStatus, 1000);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ NVD: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
    }).catch(_=>showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ NVD', 'error'));
}

function quickNvdFull() {
    fetch('/api/nvd/sync/full', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(r=>r.json()).then(data=>{
            if (data.status === 'success') {
                showNotification('NVD –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞', 'success');
                setTimeout(refreshParsersStatus, 1000);
            } else {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ NVD –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        }).catch(_=>showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ NVD –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error'));
}

function quickRedHatRecent() {
    fetch('/api/redhat/import', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ recent_days: 7 })
    }).then(r=>r.json()).then(data=>{
        if (data.success) {
            const result = data.result || {};
            const saved = result.successfully_saved || 0;
            showNotification('Red Hat –∏–º–ø–æ—Ä—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π –∑–∞–ø—É—â–µ–Ω. –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + saved + ' —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π', 'success');
            setTimeout(refreshParsersStatus, 1000);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Red Hat –∏–º–ø–æ—Ä—Ç–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
    }).catch(_=>showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Red Hat –∏–º–ø–æ—Ä—Ç–∞', 'error'));
}

function schedulerStartHourly() {
    fetch('/api/nvd/scheduler/start', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode: 'hourly' })
    }).then(r=>r.json()).then(_=>showNotification('–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: –∑–∞–ø—É—Å–∫ –ø–æ —á–∞—Å–∞–º', 'success'))
      .catch(_=>showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞', 'error'));
}
function schedulerStartDaily() {
    fetch('/api/nvd/scheduler/start', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode: 'daily', hour: 2, minute: 0 })
    }).then(r=>r.json()).then(_=>showNotification('–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ 02:00', 'success'))
      .catch(_=>showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞', 'error'));
}
function schedulerStop() {
    fetch('/api/nvd/scheduler/stop', { method: 'POST' })
        .then(r=>r.json()).then(_=>showNotification('–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success'))
        .catch(_=>showNotification('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞', 'error'));
}
        // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        // –ü–∞—Ä—Å–µ—Ä-–º–µ–Ω—é —É–¥–∞–ª–µ–Ω –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ (–±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö —à–∞–±–ª–æ–Ω–∞—Ö)
        function startParsing() {
            console.log('–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω');
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('mobile-menu');
            const button = document.getElementById('mobile-menu-button');

            if (!menu.contains(event.target) && !button.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
    </script>

    {% block scripts %}{% endblock %}

<!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ -->
<div id="globalParsingStatus" class="hidden fixed top-20 right-4 z-50 bg-white rounded-2xl shadow-2xl border border-gray-200 min-w-96 max-w-2xl">
    <div class="p-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class="fas fa-sync-alt fa-spin text-blue-500 mr-2"></i>
                –ü–∞—Ä—Å–∏–Ω–≥ OSV
            </h3>
            <button onclick="hideGlobalParsingStatus()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="p-4">
        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
        <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 mb-1">
                <span id="globalParsingProgressText">0%</span>
                <span id="globalParsingStep">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="globalProgressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã -->
        <div class="space-y-2 max-h-60 overflow-y-auto">
            <div id="globalStatusMessages" class="text-sm">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="globalParsingStats" class="mt-4 p-3 bg-gray-50 rounded-lg hidden">
            <div class="grid grid-cols-2 gap-4 text-xs">
                <div>
                    <span class="text-gray-600">–ù–∞–π–¥–µ–Ω–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π:</span>
                    <span id="statsFound" class="font-semibold ml-1">0</span>
                </div>
                <div>
                    <span class="text-gray-600">AI —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π:</span>
                    <span id="statsAI" class="font-semibold ml-1">0</span>
                </div>
                <div>
                    <span class="text-gray-600">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:</span>
                    <span id="statsSaved" class="font-semibold ml-1">0</span>
                </div>
                <div>
                    <span class="text-gray-600">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü:</span>
                    <span id="statsPages" class="font-semibold ml-1">0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–º –ø–∞—Ä—Å–∏–Ω–≥–∞
window.globalParsingState = {
    isActive: false,
    eventSource: null
};

// –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–∏–Ω–≥–∞
window.showGlobalParsingStatus = function() {
    const statusElement = document.getElementById('globalParsingStatus');
    statusElement.classList.remove('hidden');
    statusElement.classList.add('animate-fade-in');
};

// –°–∫—Ä—ã—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–∏–Ω–≥–∞
window.hideGlobalParsingStatus = function() {
    const statusElement = document.getElementById('globalParsingStatus');
    statusElement.classList.add('hidden');

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º EventSource –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω
    if (window.globalParsingState.eventSource) {
        window.globalParsingState.eventSource.close();
        window.globalParsingState.eventSource = null;
    }
    window.globalParsingState.isActive = false;
};

// –ó–∞–ø—É—Å–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
window.startGlobalParsing = function() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    window.showGlobalParsingStatus();
    window.globalParsingState.isActive = true;

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('globalStatusMessages').innerHTML = '';
    document.getElementById('globalProgressBar').style.width = '0%';
    document.getElementById('globalParsingProgressText').textContent = '0%';
    document.getElementById('globalParsingStep').textContent = '–ó–∞–ø—É—Å–∫...';
    document.getElementById('globalParsingStats').classList.add('hidden');

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥
    fetch('/api/start-parsing', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addStatusMessage('–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω', 'success');
            trackGlobalParsingProgress();
        } else {
            addStatusMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ' + data.error, 'error');
            setTimeout(() => window.hideGlobalParsingStatus(), 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addStatusMessage('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
        setTimeout(() => window.hideGlobalParsingStatus(), 3000);
    });
};

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
function trackGlobalParsingProgress() {
    const eventSource = new EventSource('/api/parsing-progress');
    window.globalParsingState.eventSource = eventSource;

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
        if (data.progress !== undefined) {
            const progress = data.progress;
            document.getElementById('globalProgressBar').style.width = progress + '%';
            document.getElementById('globalParsingProgressText').textContent = progress + '%';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥
        if (data.message) {
            document.getElementById('globalParsingStep').textContent = data.message;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (data.detailed_message) {
            addStatusMessage(data.detailed_message, data.message_type || 'info');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        if (data.stats) {
            updateParsingStats(data.stats);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        if (data.status === 'completed') {
            addStatusMessage('‚úÖ ' + (data.final_message || '–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω'), 'success');
            document.getElementById('globalProgressBar').style.width = '100%';
            document.getElementById('globalParsingProgressText').textContent = '100%';
            document.getElementById('globalParsingStep').textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (window.globalParsingState.isActive) {
                    window.hideGlobalParsingStatus();
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –µ—Å–ª–∏ –º—ã –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
                    if (window.location.pathname === '/' || window.location.pathname === '/vulnerabilities') {
                        setTimeout(() => location.reload(), 1000);
                    }
                }
            }, 5000);

            eventSource.close();
            window.globalParsingState.isActive = false;

        } else if (data.status === 'error') {
            addStatusMessage('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞'), 'error');
            setTimeout(() => window.hideGlobalParsingStatus(), 5000);
            eventSource.close();
            window.globalParsingState.isActive = false;
        }
    };

    eventSource.onerror = function(event) {
        console.error('EventSource failed:', event);
        if (window.globalParsingState.isActive) {
            addStatusMessage('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ', 'error');
            setTimeout(() => window.hideGlobalParsingStatus(), 3000);
        }
        eventSource.close();
        window.globalParsingState.isActive = false;
    };
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å—Ç–∞—Ç—É—Å
function addStatusMessage(message, type = 'info') {
    const messagesContainer = document.getElementById('globalStatusMessages');
    const messageElement = document.createElement('div');

    const icons = {
        'info': 'üîç',
        'success': '‚úÖ',
        'warning': '‚ö†Ô∏è',
        'error': '‚ùå',
        'ai': 'ü§ñ',
        'page': 'üìÑ',
        'vuln': 'üêõ'
    };

    const colors = {
        'info': 'text-blue-600',
        'success': 'text-green-600',
        'warning': 'text-yellow-600',
        'error': 'text-red-600',
        'ai': 'text-purple-600',
        'page': 'text-indigo-600',
        'vuln': 'text-orange-600'
    };

    messageElement.className = `flex items-start space-x-2 py-1 ${colors[type] || colors.info}`;
    messageElement.innerHTML = `
        <span class="flex-shrink-0">${icons[type] || icons.info}</span>
        <span class="text-sm">${message}</span>
    `;

    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateParsingStats(stats) {
    const statsElement = document.getElementById('globalParsingStats');
    statsElement.classList.remove('hidden');

    if (stats.found !== undefined) {
        document.getElementById('statsFound').textContent = stats.found;
    }
    if (stats.ai_vulnerabilities !== undefined) {
        document.getElementById('statsAI').textContent = stats.ai_vulnerabilities;
    }
    if (stats.saved !== undefined) {
        document.getElementById('statsSaved').textContent = stats.saved;
    }
    if (stats.pages_processed !== undefined) {
        document.getElementById('statsPages').textContent = stats.pages_processed;
    }
}

// –°—Ç–∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
const style = document.createElement('style');
style.textContent = `
    @keyframes fade-in {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
        animation: fade-in 0.3s ease-out;
    }
`;
document.head.appendChild(style);
</script>
<script>
// –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
window.globalParsingState = {
    isActive: false,
    eventSource: null,
    lastProgress: 0,
    lastMessage: '',
    lastStep: ''
};

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–∞—Ä—Å–∏–Ω–≥
document.addEventListener('DOMContentLoaded', function() {
    checkParsingStatus();
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function checkParsingStatus() {
    fetch('/api/parsing-status')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.status.status === 'running') {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–∏–Ω–≥–∞
                restoreParsingStatus(data.status);
            }
        })
        .catch(error => {
            console.log('No active parsing session');
        });
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
function restoreParsingStatus(status) {
    window.showGlobalParsingStatus();
    window.globalParsingState.isActive = true;

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    document.getElementById('globalProgressBar').style.width = status.progress + '%';
    document.getElementById('globalParsingProgressText').textContent = status.progress + '%';
    document.getElementById('globalParsingStep').textContent = status.message;

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (status.detailed_message) {
        addStatusMessage(status.detailed_message, status.message_type || 'info');
    }

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if (status.stats) {
        updateParsingStats(status.stats);
    }

    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
    trackGlobalParsingProgress();
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
// [–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞]
</script>
</body>
</html>