{% extends "base.html" %}

{% block content %}
<div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-800">–°—Ç–∞—Ç—É—Å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π</h2>
        <p class="text-sm text-gray-600 mt-1">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–µ –ø–∞—Ä—Å–µ—Ä–∞ OSV</p>
    </div>

    <div class="p-6">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-100 rounded-xl p-6 mb-6 border border-blue-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">
                        <i class="fas fa-satellite-dish mr-2 text-blue-600"></i>
                        –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
                    </h3>
                    <p class="text-sm text-gray-600">
                        {% if status.status == 'ready' %}
                        <span class="text-green-600 font-semibold">‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</span>
                        {% elif status.status == 'error' %}
                        <span class="text-red-600 font-semibold">‚ùå –û—à–∏–±–∫–∞</span>
                        {% else %}
                        <span class="text-yellow-600 font-semibold">üîÑ –í —Ä–∞–±–æ—Ç–µ</span>
                        {% endif %}
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">–ë–∞–∑–∞ URL:</p>
                    <p class="font-mono text-sm">{{ status.base_url }}</p>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ -->
        <div id="parsing-progress-section" class="mb-6 hidden">
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-sync-alt mr-2 text-blue-600"></i>
                    –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                </h3>

                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
                <div class="mb-4">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700" id="progress-text">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span>
                        <span class="text-sm font-medium text-gray-700" id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-blue-600" id="vuln-found">0</p>
                        <p class="text-sm text-gray-600">–ù–∞–π–¥–µ–Ω–æ</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-green-600" id="vuln-saved">0</p>
                        <p class="text-sm text-gray-600">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-purple-600" id="current-step">-</p>
                        <p class="text-sm text-gray-600">–¢–µ–∫—É—â–∏–π —à–∞–≥</p>
                    </div>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ -->
                <div class="bg-gray-50 rounded-lg p-4 max-h-40 overflow-y-auto">
                    <h4 class="font-medium text-gray-700 mb-2">–õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</h4>
                    <div id="progress-messages" class="space-y-1 text-sm">
                        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>
        </div>

        <!-- –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ -->
        <div id="live-vulnerabilities-section" class="mb-6 hidden">
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-bolt mr-2 text-green-600"></i>
                        –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    </h3>
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></span>
                            LIVE
                        </span>
                        <span id="live-vuln-count" class="text-sm text-gray-600">0 –¥–æ–±–∞–≤–ª–µ–Ω–æ</span>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π -->
                <div id="vulnerabilities-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ -->
                    <div id="no-vulnerabilities" class="text-center py-8 text-gray-500">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p>–£—è–∑–≤–∏–º–æ—Å—Ç–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –≤–æ –≤—Ä–µ–º—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg p-4 border border-gray-200">
                <div class="text-center">
                    <p class="text-2xl font-bold text-blue-600">{{ status.max_pages }}</p>
                    <p class="text-sm text-gray-600">–ú–∞–∫—Å. —Å—Ç—Ä–∞–Ω–∏—Ü</p>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-gray-200">
                <div class="text-center">
                    <p class="text-2xl font-bold text-green-600">{{ status.keywords_count }}</p>
                    <p class="text-sm text-gray-600">–ö–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤</p>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-gray-200">
                <div class="text-center">
                    <p class="text-2xl font-bold text-purple-600">{{ status.total_in_system if status.total_in_system else 0 }}</p>
                    <p class="text-sm text-gray-600">–£—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ</p>
                </div>
            </div>
        </div>

        {% if status.error %}
        <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                <div>
                    <h4 class="font-semibold text-red-800">–û—à–∏–±–∫–∞</h4>
                    <p class="text-red-600 text-sm">{{ status.error }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–∞—Ä—Å–µ—Ä–∞</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>‚Ä¢ –ë–∞–∑–æ–≤–∞—è URL: {{ status.base_url }}</li>
                        <li>‚Ä¢ –ú–∞–∫—Å–∏–º—É–º —Å—Ç—Ä–∞–Ω–∏—Ü: {{ status.max_pages }}</li>
                        <li>‚Ä¢ –ö–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤: {{ status.keywords_count }}</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>‚Ä¢ –í—Å–µ–≥–æ –≤ —Å–∏—Å—Ç–µ–º–µ: {{ status.total_in_system if status.total_in_system else 0 }} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π</li>
                        <li>‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {{ status.total_processed if status.total_processed else 0 }} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π</li>
                        <li>‚Ä¢ –°—Ç–∞—Ç—É—Å:
                            {% if status.system_status == 'operational' %}
                                <span class="text-green-600">‚úÖ –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π</span>
                            {% else %}
                                <span class="text-red-600">‚ùå –û—à–∏–±–∫–∞</span>
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="flex space-x-4 pt-4 border-t border-gray-200">
            <button onclick="startParsing()" id="start-parsing-btn"
               class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-md hover:shadow-lg">
                <i class="fas fa-play mr-2"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            </button>
            <a href="{{ url_for('vulnerabilities_list') }}"
               class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300">
                <i class="fas fa-list mr-2"></i> –°–ø–∏—Å–æ–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
            </a>
            <a href="{{ url_for('dashboard') }}"
               class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300">
                <i class="fas fa-arrow-left mr-2"></i> –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notifications" class="fixed top-4 right-4 space-y-2 z-50"></div>

<style>
.vulnerability-item {
    animation: slideIn 0.3s ease-out;
    border-left: 4px solid;
}

.vulnerability-item.critical { border-left-color: #dc2626; }
.vulnerability-item.high { border-left-color: #ea580c; }
.vulnerability-item.medium { border-left-color: #d97706; }
.vulnerability-item.low { border-left-color: #16a34a; }

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.severity-badge {
    @apply px-2 py-1 text-xs font-semibold rounded-full;
}

.severity-critical { @apply bg-red-100 text-red-800; }
.severity-high { @apply bg-orange-100 text-orange-800; }
.severity-medium { @apply bg-yellow-100 text-yellow-800; }
.severity-low { @apply bg-green-100 text-green-800; }
</style>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let progressEventSource = null;
let vulnerabilitiesEventSource = null;
let liveVulnCount = 0;

// –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞
function startParsing() {
    const btn = document.getElementById('start-parsing-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-sync-alt animate-spin mr-2"></i> –ó–∞–ø—É—Å–∫...';

    fetch('/api/start-parsing', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!', 'success');
                startLiveUpdates();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play mr-2"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error, 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play mr-2"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';
        });
}

// –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
function startLiveUpdates() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏
    document.getElementById('parsing-progress-section').classList.remove('hidden');
    document.getElementById('live-vulnerabilities-section').classList.remove('hidden');

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    startProgressTracking();

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
    startVulnerabilitiesTracking();
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
function startProgressTracking() {
    if (progressEventSource) progressEventSource.close();

    progressEventSource = new EventSource('/api/parsing-progress');

    progressEventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        updateProgressUI(data);
    };

    progressEventSource.onerror = function(event) {
        console.error('Progress SSE error:', event);
        // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    };
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
function startVulnerabilitiesTracking() {
    if (vulnerabilitiesEventSource) vulnerabilitiesEventSource.close();

    vulnerabilitiesEventSource = new EventSource('/api/live-parsing-vulnerabilities');

    vulnerabilitiesEventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.type === 'vulnerability') {
            addVulnerabilityToList(data.vulnerability);
        } else if (data.type === 'parsing_complete') {
            showNotification('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'success');
            document.getElementById('start-parsing-btn').disabled = false;
            document.getElementById('start-parsing-btn').innerHTML = '<i class="fas fa-play mr-2"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';
        }
    };

    vulnerabilitiesEventSource.onerror = function(event) {
        console.error('Vulnerabilities SSE error:', event);
    };
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateProgressUI(progress) {
    // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
    document.getElementById('progress-bar').style.width = progress.progress + '%';
    document.getElementById('progress-percent').textContent = progress.progress + '%';
    document.getElementById('progress-text').textContent = progress.message;

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    document.getElementById('vuln-found').textContent = progress.vulnerabilities_found || 0;
    document.getElementById('vuln-saved').textContent = progress.vulnerabilities_saved || 0;
    document.getElementById('current-step').textContent = progress.current_step || '-';

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–≥
    if (progress.message) {
        addProgressMessage(progress.message);
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ —Å–ø–∏—Å–æ–∫
function addVulnerabilityToList(vulnerability) {
    const list = document.getElementById('vulnerabilities-list');
    const noVuln = document.getElementById('no-vulnerabilities');

    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π"
    if (noVuln) noVuln.remove();

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–∏
    const vulnElement = document.createElement('div');
    vulnElement.className = `vulnerability-item ${vulnerability.severity} bg-white p-4 rounded-lg border border-gray-200 shadow-sm`;

    const severityClass = `severity-badge severity-${vulnerability.severity}`;

    vulnElement.innerHTML = `
        <div class="flex justify-between items-start">
            <div class="flex-1">
                <h4 class="font-semibold text-gray-800 mb-1">${vulnerability.title}</h4>
                <p class="text-sm text-gray-600 mb-2 line-clamp-2">${vulnerability.description}</p>
                <div class="flex items-center space-x-3 text-xs text-gray-500">
                    <span class="flex items-center">
                        <i class="fas fa-tag mr-1"></i>
                        ${vulnerability.category}
                    </span>
                    <span class="flex items-center">
                        <i class="fas fa-clock mr-1"></i>
                        ${new Date(vulnerability.timestamp).toLocaleTimeString()}
                    </span>
                </div>
            </div>
            <div class="text-right ml-4">
                <span class="${severityClass}">${vulnerability.severity}</span>
                <p class="text-sm font-semibold mt-1">CVSS: ${vulnerability.cvss_score}</p>
            </div>
        </div>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –≤ –Ω–∞—á–∞–ª–æ
    list.insertBefore(vulnElement, list.firstChild);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    liveVulnCount++;
    document.getElementById('live-vuln-count').textContent = `${liveVulnCount} –¥–æ–±–∞–≤–ª–µ–Ω–æ`;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showNewVulnerabilityNotification(vulnerability.title, vulnerability.severity);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function addProgressMessage(message) {
    const messagesContainer = document.getElementById('progress-messages');
    const messageElement = document.createElement('div');
    messageElement.className = 'text-gray-600';
    messageElement.innerHTML = `<i class="fas fa-circle text-blue-500 mr-2" style="font-size: 6px;"></i>${message}`;

    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤–æ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏
function showNewVulnerabilityNotification(title, severity) {
    const severityIcons = {
        'critical': 'üî¥',
        'high': 'üü†',
        'medium': 'üü°',
        'low': 'üü¢'
    };

    const icon = severityIcons[severity] || '‚ö™';

    showNotification(`${icon} –î–æ–±–∞–≤–ª–µ–Ω–∞: ${title}`, 'success', 3000);
}

// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info', duration = 5000) {
    const notifications = document.getElementById('notifications');
    const notification = document.createElement('div');

    const typeClasses = {
        'success': 'bg-green-500 text-white',
        'error': 'bg-red-500 text-white',
        'info': 'bg-blue-500 text-white'
    };

    notification.className = `${typeClasses[type]} px-4 py-3 rounded-lg shadow-lg transform transition-transform duration-300 translate-x-full`;
    notification.innerHTML = message;

    notifications.appendChild(notification);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 10);

    // –ê–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, duration);
}

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
window.addEventListener('beforeunload', function() {
    if (progressEventSource) progressEventSource.close();
    if (vulnerabilitiesEventSource) vulnerabilitiesEventSource.close();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    fetch('/api/parsing-status')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.status.status === 'running') {
                // –ï—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ —É–∂–µ –∑–∞–ø—É—â–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                startLiveUpdates();
                updateProgressUI(data.status);
            }
        });
});
</script>
{% endblock %}