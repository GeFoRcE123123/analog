import logging
import re
from typing import Dict, Any, List, Tuple
from datetime import datetime
import random

logger = logging.getLogger(__name__)


class VulnerabilityAnalyzer:
    """–£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è —Ä–∏—Å–∫–∞"""

    def __init__(self):
        self.risk_patterns = {
            'critical': [
                r'\bremote.*code.*execution\b', r'\brce\b', r'\bcommand.*injection\b',
                r'\bprivilege.*escalation\b', r'\broot.*access\b', r'\barbitrary.*code\b',
                r'\bmemory.*corruption\b', r'\bbuffer.*overflow\b', r'\bheap.*overflow\b',
                r'\bcritical\b', r'\bcvss.*[89]\b', r'\bcvss.*10\b', r'\bhigh.*severity\b',
                r'\bauthentication.*bypass\b', r'\bbackdoor\b', r'\bunauthorized.*access\b'
            ],
            'high': [
                r'\bsql.*injection\b', r'\bxss\b', r'\bcsrf\b', r'\bpath.*traversal\b',
                r'\bdirectory.*traversal\b', r'\bfile.*inclusion\b', r'\binformation.*disclosure\b',
                r'\bdata.*leak\b', r'\bcredentials\b', r'\bdenial.*of.*service\b', r'\bdos\b',
                r'\bbrute.*force\b', r'\bhigh.*risk\b', r'\bcvss.*[67]\b', r'\bexploit\b',
                r'\bvulnerability\b', r'\bsecurity\b'
            ],
            'medium': [
                r'\bcross.*site\b', r'\bclickjacking\b', r'\bopen.*redirect\b',
                r'\bsession.*fixation\b', r'\binformation.*leak\b', r'\berror.*message\b',
                r'\bmedium.*risk\b', r'\bcvss.*[45]\b', r'\bmoderate\b'
            ],
            'low': [
                r'\blow.*risk\b', r'\bcvss.*[0-3]\b', r'\binformation\b', r'\bdebug\b',
                r'\bverbose\b', r'\bminor\b', r'\btrivial\b'
            ]
        }

        # AI-specific —Ä–∏—Å–∫–∏ (–ø–æ–≤—ã—à–∞–µ–º severity –¥–ª—è AI —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π)
        self.ai_risk_boosters = {
            'tensorflow': 2.0, 'pytorch': 2.0, 'huggingface': 2.0, 'hugging face': 2.0,
            'openai': 2.0, 'gpt': 2.0, 'llm': 2.0, 'large language model': 2.0,
            'machine learning': 1.5, 'neural network': 1.5, 'ai model': 2.0,
            'prompt injection': 3.0, 'jailbreak': 3.0, 'model extraction': 2.5,
            'training data': 1.5, 'inference': 1.5, 'transformer': 1.5
        }

        # –í–µ—Å–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        self.weights = {
            'title': 3.0,
            'cves': 2.0,
            'description': 1.5,
            'packages': 1.0,
            'full_text': 0.5
        }

    def analyze_vulnerability(self, vuln_data: Dict[str, Any]) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —É—è–∑–≤–∏–º–æ—Å—Ç—å –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞"""
        try:
            # –°–æ–±–∏—Ä–∞–µ–º –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
            analysis_text = self._build_analysis_text(vuln_data)

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
            risk_level, confidence, risk_score = self._determine_risk_level_advanced(analysis_text)

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            category = self._determine_category(analysis_text)

            # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
            description = self._generate_description(vuln_data, risk_level, category)

            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º CVSS score –Ω–∞ –æ—Å–Ω–æ–≤–µ risk_score
            cvss_score = self._calculate_cvss_score(risk_score)

            logger.info(
                f"üîç Analyzed: {vuln_data.get('id', 'Unknown')} -> {risk_level} (score: {risk_score}, CVSS: {cvss_score})")

            return {
                'severity': risk_level,
                'risk_level': risk_level,
                'cvss_score': cvss_score,
                'category': category,
                'description': description,
                'confidence': confidence,
                'risk_score': risk_score
            }

        except Exception as e:
            logger.error(f"Error analyzing vulnerability: {e}")
            return self._get_default_analysis()

    def _build_analysis_text(self, vuln_data: Dict[str, Any]) -> Dict[str, str]:
        """–°—Ç—Ä–æ–∏—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º"""
        components = {}

        # ID —É—è–∑–≤–∏–º–æ—Å—Ç–∏
        components['title'] = vuln_data.get('id', '').lower()

        # –û–ø–∏—Å–∞–Ω–∏–µ
        components['description'] = vuln_data.get('description', '').lower()

        # CVE
        cves = vuln_data.get('cves', [])
        components['cves'] = ' '.join(cves).lower()

        # –ü–∞–∫–µ—Ç—ã
        packages = vuln_data.get('packages', [])
        package_names = [pkg.get('name', '') for pkg in packages]
        components['packages'] = ' '.join(package_names).lower()

        # –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
        components['full_text'] = vuln_data.get('full_text', '').lower()

        return components

    def _determine_risk_level_advanced(self, components: Dict[str, str]) -> Tuple[str, float, float]:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π"""
        total_score = 0.0
        max_possible_score = 0.0

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å –µ–≥–æ –≤–µ—Å–æ–º
        for component, text in components.items():
            weight = self.weights.get(component, 1.0)
            component_score = self._analyze_component(text, component)
            total_score += component_score * weight
            max_possible_score += 10.0 * weight  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π score –∑–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º score
        normalized_score = (total_score / max_possible_score) * 100 if max_possible_score > 0 else 0

        # –ü—Ä–∏–º–µ–Ω—è–µ–º AI boost
        ai_boost = self._calculate_ai_boost(' '.join(components.values()))
        boosted_score = normalized_score * ai_boost

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞
        risk_level, confidence = self._score_to_risk_level(boosted_score)

        return risk_level, confidence, boosted_score

    def _analyze_component(self, text: str, component: str) -> float:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞"""
        if not text:
            return 0.0

        score = 0.0

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–∏—Å–∫–∞
        for level, patterns in self.risk_patterns.items():
            level_weight = {'critical': 4.0, 'high': 3.0, 'medium': 2.0, 'low': 1.0}[level]

            for pattern in patterns:
                matches = re.findall(pattern, text, re.IGNORECASE)
                if matches:
                    score += len(matches) * level_weight

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
        if component == 'title':
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Å –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å CVE
            if 'cve' in text:
                score += 2.0
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Å –¥–ª—è GitHub Security Advisories
            if 'ghsa' in text:
                score += 1.5

        return min(score, 10.0)  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π score

    def _calculate_ai_boost(self, text: str) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç boost –¥–ª—è AI —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π"""
        boost = 1.0

        for keyword, boost_value in self.ai_risk_boosters.items():
            if re.search(r'\b' + re.escape(keyword) + r'\b', text, re.IGNORECASE):
                boost = max(boost, boost_value)
                logger.debug(f"AI boost applied: {keyword} -> {boost_value}")

        return boost

    def _score_to_risk_level(self, score: float) -> Tuple[str, float]:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç score –≤ —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞"""
        if score >= 70:
            return 'critical', min(1.0, score / 100)
        elif score >= 50:
            return 'high', min(1.0, score / 100)
        elif score >= 30:
            return 'medium', min(1.0, score / 100)
        else:
            return 'low', min(1.0, score / 100)

    def _calculate_cvss_score(self, risk_score: float) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç CVSS score –Ω–∞ –æ—Å–Ω–æ–≤–µ risk_score"""
        # –ú–∞–ø–ø–∏–º risk_score (0-100) –≤ CVSS (0-10)
        cvss_score = (risk_score / 100) * 10.0

        # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
        variation = random.uniform(-0.5, 0.5)
        cvss_score += variation

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –∏ –æ–∫—Ä—É–≥–ª—è–µ–º
        return round(max(0.0, min(10.0, cvss_score)), 1)

    def _determine_category(self, components: Dict[str, str]) -> str:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é —É—è–∑–≤–∏–º–æ—Å—Ç–∏"""
        text = ' '.join(components.values()).lower()

        # AI/ML –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        ai_keywords = ['ai', 'machine learning', 'neural', 'tensorflow', 'pytorch',
                       'huggingface', 'openai', 'gpt', 'llm', 'transformer', 'prompt']
        if any(re.search(r'\b' + re.escape(keyword) + r'\b', text) for keyword in ai_keywords):
            return 'ai'

        # Web security
        web_keywords = ['sql', 'xss', 'csrf', 'injection', 'web', 'http', 'api', 'cross.site']
        if any(re.search(r'\b' + re.escape(keyword) + r'\b', text) for keyword in web_keywords):
            return 'web'

        # System security
        system_keywords = ['buffer', 'memory', 'privilege', 'root', 'kernel', 'execution']
        if any(re.search(r'\b' + re.escape(keyword) + r'\b', text) for keyword in system_keywords):
            return 'system'

        return 'other'

    def _generate_description(self, vuln_data: Dict[str, Any], risk_level: str, category: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º"""
        title = vuln_data.get('id', 'Security vulnerability')

        # –ë–∞–∑–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ based on risk level
        risk_descriptions = {
            'critical': 'Critical security vulnerability that requires immediate attention',
            'high': 'High severity security issue that should be addressed promptly',
            'medium': 'Medium risk security vulnerability',
            'low': 'Low impact security finding'
        }

        description = risk_descriptions.get(risk_level, 'Security vulnerability')

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        category_descriptions = {
            'ai': ' in AI/ML infrastructure',
            'web': ' in web application components',
            'system': ' in system-level components',
            'other': ' in software components'
        }

        description += category_descriptions.get(category, '')

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
        details = []

        if vuln_data.get('cves'):
            cves = vuln_data['cves'][:2]
            details.append(f"identified as {', '.join(cves)}")

        if vuln_data.get('packages'):
            packages = [pkg['name'] for pkg in vuln_data['packages'][:2] if pkg.get('name')]
            if packages:
                details.append(f"affects {', '.join(packages)}")

        if details:
            description += ". " + '. '.join(details)

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
        return description[:500] + ('.' if not description.endswith('.') else '')

    def _get_default_analysis(self) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        return {
            'severity': 'medium',
            'risk_level': 'medium',
            'cvss_score': 5.0,
            'category': 'other',
            'description': 'Security vulnerability requiring investigation',
            'confidence': 0.5,
            'risk_score': 50.0
        }


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
vulnerability_analyzer = VulnerabilityAnalyzer()