"""
HTML-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –∏–∑ HTML-—Ä–∞–∑–º–µ—Ç–∫–∏ –≤–µ–±-—Å–∞–π—Ç–æ–≤
"""

import requests
import logging
import time
import re
from typing import List, Dict, Any, Optional
from datetime import datetime
from bs4 import BeautifulSoup
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# Import the correct Vulnerability entity
from models.entities import Vulnerability

logger = logging.getLogger(__name__)


class HTMLVulnerabilityParser:
    """HTML-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ —Ä–∞–∑–º–µ—Ç–∫–∏ –≤–µ–±-—Å–∞–π—Ç–æ–≤"""
    
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        })
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ HTML-–ø–∞—Ä—Å–∏–Ω–≥
        self.sources = {
            'ubuntu': {
                'type': 'html',
                'base_url': 'https://ubuntu.com/security',
                'cve_list_url': 'https://ubuntu.com/security/cves.json',
                'parser': self._parse_ubuntu_html
            },
            'debian': {
                'type': 'html',
                'base_url': 'https://security-tracker.debian.org/tracker',
                'cve_list_url': 'https://security-tracker.debian.org/tracker/data/json',
                'parser': self._parse_debian_html
            },
            'nvd': {
                'type': 'html',
                'base_url': 'https://nvd.nist.gov/vuln/detail',
                'parser': self._parse_nvd_html
            },
            'redhat': {
                'type': 'html',
                'base_url': 'https://access.redhat.com/security/cve',
                'parser': self._parse_redhat_html
            }
        }
    
    def parse_source(self, source_name: str, cve_list: Optional[List[str]] = None, limit: int = 50) -> List[Dict]:
        """
        –ü–∞—Ä—Å–∏–Ω–≥ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        
        Args:
            source_name: –ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (ubuntu, debian, nvd, redhat)
            cve_list: –°–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö CVE –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
            
        Returns:
            List[Dict]: –°–ø–∏—Å–æ–∫ —Å–ø–∞—Ä—Å–µ–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
        """
        if source_name not in self.sources:
            logger.warning(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫: {source_name}")
            return []
        
        logger.info(f"üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ {source_name}...")
        
        try:
            source_config = self.sources[source_name]
            
            # –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ CVE –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω, –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ
            if cve_list is None:
                cve_list = self._get_cve_list(source_name, limit)
            
            vulnerabilities = []
            for cve_id in cve_list[:limit]:
                try:
                    logger.info(f"–ü–∞—Ä—Å–∏–º {cve_id} –∏–∑ {source_name}")
                    vuln_data = source_config['parser'](cve_id)
                    if vuln_data:
                        vulnerabilities.append(vuln_data)
                        logger.info(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è {cve_id}")
                    else:
                        logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è {cve_id}")
                    
                    # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ—Ä–≤–µ—Ä
                    time.sleep(0.5)
                    
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ {cve_id} –∏–∑ {source_name}: {e}")
            
            logger.info(f"‚úÖ {source_name}: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
            return vulnerabilities
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ {source_name}: {e}")
            return []
    
    def _get_cve_list(self, source_name: str, limit: int) -> List[str]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ CVE –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞"""
        try:
            source_config = self.sources[source_name]
            
            if source_name == 'ubuntu':
                # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ CVE –∏–∑ JSON API
                response = self.session.get(
                    source_config['cve_list_url'],
                    params={'limit': limit},
                    timeout=30
                )
                response.raise_for_status()
                data = response.json()
                return [cve['id'] for cve in data.get('cves', [])[:limit]]
            
            elif source_name == 'debian':
                # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ CVE –∏–∑ JSON API
                response = self.session.get(
                    source_config['cve_list_url'],
                    timeout=60
                )
                response.raise_for_status()
                data = response.json()
                # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–ª—é—á—É –∏ –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ
                sorted_cves = sorted(data.keys(), reverse=True)
                return sorted_cves[:limit]
            
            else:
                # For other sources, return a default list of recent CVEs
                # In real implementation, this would fetch from the source
                default_cves = [
                    'CVE-2024-56789', 'CVE-2024-56788', 'CVE-2024-56787',
                    'CVE-2024-56786', 'CVE-2024-56785', 'CVE-2024-56784'
                ]
                return default_cves[:limit]
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ CVE –∏–∑ {source_name}: {e}")
            return []
    
    def _parse_ubuntu_html(self, cve_id: str) -> Optional[Dict[str, Any]]:
        """
        –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏–∑ HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã Ubuntu
        
        –ò–∑–≤–ª–µ–∫–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
        - CVE ID
        - –ù–∞–∑–≤–∞–Ω–∏–µ/–ó–∞–≥–æ–ª–æ–≤–æ–∫
        - –û–ø–∏—Å–∞–Ω–∏–µ
        - –£—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ (Priority)
        - –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        - –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–∞–∫–µ—Ç—ã –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å
        - –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        """
        try:
            url = f"{self.sources['ubuntu']['base_url']}/{cve_id}"
            response = self.session.get(url, timeout=30)
            response.raise_for_status()
            
            soup = BeautifulSoup(response.content, 'html.parser')
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            vulnerability_data: Dict[str, Any] = {
                'source': 'ubuntu',
                'cve_id': cve_id,
                'url': url,
                'parsed_from': 'html_markup'
            }
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            title_elem = soup.find('title')
            if title_elem:
                vulnerability_data['title'] = str(title_elem.get_text().strip())
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –º–µ—Ç–∞-—Ç–µ–≥–∞
            meta_desc = soup.find('meta', attrs={'name': 'description'})
            if meta_desc:
                vulnerability_data['description'] = str(meta_desc.get('content', ''))
            
            # –ò—â–µ–º –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–µ
            main_content = soup.find('main') or soup.find('div', class_=re.compile(r'content|main', re.I))
            if main_content:
                # –ò—â–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã —Å —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
                paragraphs = main_content.find_all('p')
                for p in paragraphs:
                    text = str(p.get_text().strip())
                    if len(text) > 100 and 'ubuntu' not in text.lower():
                        if 'description' not in vulnerability_data or len(text) > len(vulnerability_data.get('description', '')):
                            vulnerability_data['description'] = text
                        break
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
            priority_text = str(soup.get_text())
            priority_match = re.search(r'(Priority|Severity):\s*(\w+)', priority_text, re.I)
            if priority_match:
                vulnerability_data['severity'] = str(priority_match.group(2).lower())
            else:
                vulnerability_data['severity'] = 'unknown'
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
            date_matches = re.findall(r'\b\d{4}-\d{2}-\d{2}\b', str(soup.get_text()))
            if date_matches:
                try:
                    vulnerability_data['published'] = str(date_matches[0])
                except:
                    pass
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–∫–µ—Ç–∞—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü
            packages = self._extract_ubuntu_packages(soup)
            if packages:
                vulnerability_data['affected_packages'] = packages
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫–∏
            links = self._extract_links(soup, url)
            if links:
                vulnerability_data['references'] = links
            
            return vulnerability_data
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ Ubuntu CVE {cve_id}: {e}")
            return None
    
    def _extract_ubuntu_packages(self, soup) -> List[Dict]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø–∞–∫–µ—Ç–∞—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü Ubuntu"""
        packages = []
        
        try:
            # –ò—â–µ–º —Ç–∞–±–ª–∏—Ü—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–∞–∫–µ—Ç–∞—Ö
            tables = soup.find_all('table')
            for table in tables:
                # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
                rows = table.find_all('tr')
                if len(rows) > 1:  # –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –∫—Ä–æ–º–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    # –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                    headers = table.find_all('th')
                    header_texts = [str(h.get_text().strip().lower()) for h in headers]
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–∞–∫–µ—Ç–∞–º–∏
                    if any('package' in h for h in header_texts):
                        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                        for row in rows[1:]:  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                            cells = row.find_all(['td', 'th'])
                            if len(cells) >= 3:
                                package_info = {
                                    'name': str(cells[0].get_text().strip()) if cells[0] else '',
                                    'release': str(cells[1].get_text().strip()) if len(cells) > 1 else '',
                                    'status': str(cells[2].get_text().strip()) if len(cells) > 2 else ''
                                }
                                if package_info['name']:
                                    packages.append(package_info)
        
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞–∫–µ—Ç–∞—Ö Ubuntu: {e}")
        
        return packages
    
    def _parse_debian_html(self, cve_id: str) -> Optional[Dict[str, Any]]:
        """
        –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏–∑ HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã Debian
        
        –ò–∑–≤–ª–µ–∫–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
        - CVE ID
        - –ù–∞–∑–≤–∞–Ω–∏–µ/–ó–∞–≥–æ–ª–æ–≤–æ–∫
        - –û–ø–∏—Å–∞–Ω–∏–µ
        - –£—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
        - –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–∞–∫–µ—Ç—ã –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å
        - –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        """
        try:
            url = f"{self.sources['debian']['base_url']}/{cve_id}"
            response = self.session.get(url, timeout=30)
            response.raise_for_status()
            
            soup = BeautifulSoup(response.content, 'html.parser')
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            vulnerability_data: Dict[str, Any] = {
                'source': 'debian',
                'cve_id': cve_id,
                'url': url,
                'parsed_from': 'html_markup'
            }
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            title_elem = soup.find('title')
            if title_elem:
                vulnerability_data['title'] = str(title_elem.get_text().strip())
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
            description = self._extract_debian_description(soup)
            if description:
                vulnerability_data['description'] = str(description)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
            severity = self._extract_debian_severity(soup)
            if severity:
                vulnerability_data['severity'] = str(severity)
            else:
                vulnerability_data['severity'] = 'unknown'
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–∫–µ—Ç–∞—Ö
            packages = self._extract_debian_packages(soup)
            if packages:
                vulnerability_data['affected_packages'] = packages
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫–∏
            links = self._extract_links(soup, url)
            if links:
                vulnerability_data['references'] = links
            
            return vulnerability_data
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ Debian CVE {cve_id}: {e}")
            return None
    
    def _extract_debian_description(self, soup) -> Optional[str]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏–∑ Debian —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        try:
            # –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
            desc_elem = soup.find('td', string=re.compile(r'Description', re.I))
            if desc_elem:
                # –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é —è—á–µ–π–∫—É, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ
                desc_content = desc_elem.find_next('td')
                if desc_content:
                    return str(desc_content.get_text().strip())
            
            # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –∏—â–µ–º –≤ —Ç–µ–∫—Å—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            page_text = str(soup.get_text())
            # –ò—â–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ "Description"
            desc_match = re.search(r'Description\s*:\s*(.*?)(?:\n\n|\Z)', page_text, re.I | re.S)
            if desc_match:
                return str(desc_match.group(1).strip())
                
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è Debian: {e}")
        
        return None
    
    def _extract_debian_severity(self, soup) -> Optional[str]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –∏–∑ Debian —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        try:
            page_text = str(soup.get_text()).lower()
            
            # –ò—â–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
            if 'critical' in page_text:
                return 'critical'
            elif 'high' in page_text:
                return 'high'
            elif 'medium' in page_text or 'moderate' in page_text:
                return 'medium'
            elif 'low' in page_text:
                return 'low'
                
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ Debian: {e}")
        
        return None
    
    def _extract_debian_packages(self, soup) -> List[Dict]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞–∫–µ—Ç–∞—Ö –∏–∑ Debian —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        packages = []
        
        try:
            # –ò—â–µ–º —Ç–∞–±–ª–∏—Ü—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–∞–∫–µ—Ç–∞—Ö
            tables = soup.find_all('table')
            for i, table in enumerate(tables):
                # –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
                headers = table.find_all('th')
                header_texts = [str(h.get_text().strip().lower()) for h in headers]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–∞–∫–µ—Ç–∞–º–∏
                package_related_headers = ['package', 'source package', 'release', 'version', 'status']
                if any(header in ' '.join(header_texts) for header in package_related_headers):
                    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
                    rows = table.find_all('tr')
                    for row in rows[1:]:  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                        cells = row.find_all('td')
                        if len(cells) >= 2:
                            package_info = {
                                'name': str(cells[0].get_text().strip()) if cells[0] else '',
                                'release': str(cells[1].get_text().strip()) if len(cells) > 1 else '',
                                'version': str(cells[2].get_text().strip()) if len(cells) > 2 else '',
                                'status': str(cells[3].get_text().strip()) if len(cells) > 3 else ''
                            }
                            if package_info['name']:
                                packages.append(package_info)
        
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞–∫–µ—Ç–∞—Ö Debian: {e}")
        
        return packages
    
    def _parse_nvd_html(self, cve_id: str) -> Optional[Dict[str, Any]]:
        """
        –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏–∑ HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã NVD
        
        –ò–∑–≤–ª–µ–∫–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
        - CVE ID
        - –ù–∞–∑–≤–∞–Ω–∏–µ/–ó–∞–≥–æ–ª–æ–≤–æ–∫
        - –û–ø–∏—Å–∞–Ω–∏–µ
        - CVSS –æ—Ü–µ–Ω–∫–∞ –∏ —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
        - –°–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ (CWE)
        - –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        - –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        """
        try:
            url = f"{self.sources['nvd']['base_url']}/{cve_id}"
            response = self.session.get(url, timeout=30)
            response.raise_for_status()
            
            soup = BeautifulSoup(response.content, 'html.parser')
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            vulnerability_data: Dict[str, Any] = {
                'source': 'nvd',
                'cve_id': cve_id,
                'url': url,
                'parsed_from': 'html_markup'
            }
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            title_elem = soup.find('title')
            if title_elem:
                vulnerability_data['title'] = str(title_elem.get_text().strip())
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
            description = self._extract_nvd_description(soup)
            if description:
                vulnerability_data['description'] = str(description)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º CVSS –æ—Ü–µ–Ω–∫—É
            cvss_info = self._extract_nvd_cvss(soup)
            if cvss_info:
                vulnerability_data.update(cvss_info)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º CWE
            cwe_info = self._extract_nvd_cwe(soup)
            if cwe_info:
                vulnerability_data['cwe'] = str(cwe_info)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            configurations = self._extract_nvd_configurations(soup)
            if configurations:
                vulnerability_data['configurations'] = configurations
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫–∏
            links = self._extract_links(soup, url)
            if links:
                vulnerability_data['references'] = links
            
            return vulnerability_data
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ NVD CVE {cve_id}: {e}")
            return None
    
    def _extract_nvd_description(self, soup) -> Optional[str]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏–∑ NVD —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        try:
            # –ò—â–µ–º —Å–µ–∫—Ü–∏—é —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
            desc_heading = soup.find('h3', string=re.compile(r'Description', re.I))
            if desc_heading:
                desc_div = desc_heading.find_next('div')
                if desc_div:
                    return str(desc_div.get_text().strip())
            
            # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –∏—â–µ–º –≤ –º–µ—Ç–∞-—Ç–µ–≥–∞—Ö
            meta_desc = soup.find('meta', attrs={'name': 'description'})
            if meta_desc:
                return str(meta_desc.get('content', ''))
                
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è NVD: {e}")
        
        return None
    
    def _extract_nvd_cvss(self, soup) -> Optional[Dict]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ CVSS –æ—Ü–µ–Ω–∫–∏ –∏–∑ NVD —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        cvss_info = {}
        
        try:
            # –ò—â–µ–º —Å–µ–∫—Ü–∏—é —Å –æ—Ü–µ–Ω–∫–æ–π —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
            severity_heading = soup.find('h3', string=re.compile(r'Severity', re.I))
            if severity_heading:
                severity_div = severity_heading.find_next('div')
                if severity_div:
                    severity_text = str(severity_div.get_text().strip())
                    # –ò—â–µ–º —á–∏—Å–ª–æ–≤—É—é –æ—Ü–µ–Ω–∫—É CVSS
                    cvss_match = re.search(r'(\d+\.\d+)', severity_text)
                    if cvss_match:
                        cvss_info['cvss_score'] = float(cvss_match.group(1))
                    
                    # –ò—â–µ–º —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
                    severity_match = re.search(r'(Critical|High|Medium|Low)', severity_text, re.I)
                    if severity_match:
                        cvss_info['severity'] = str(severity_match.group(1).lower())
        
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ CVSS NVD: {e}")
        
        return cvss_info if cvss_info else None
    
    def _extract_nvd_cwe(self, soup) -> Optional[str]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ CWE –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ NVD —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        try:
            # –ò—â–µ–º CWE –≤ —Ç–µ–∫—Å—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            page_text = str(soup.get_text())
            cwe_match = re.search(r'CWE-\d+', page_text, re.I)
            if cwe_match:
                return str(cwe_match.group(0).upper())
                
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ CWE NVD: {e}")
        
        return None
    
    def _extract_nvd_configurations(self, soup) -> List[Dict]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏–∑ NVD —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        configurations = []
        
        try:
            # –ò—â–µ–º —Ç–∞–±–ª–∏—Ü—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏
            tables = soup.find_all('table')
            for table in tables:
                # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏
                rows = table.find_all('tr')
                for row in rows:
                    cells = row.find_all('td')
                    if cells:
                        # –ò—â–µ–º CPE –≤ —è—á–µ–π–∫–∞—Ö
                        for cell in cells:
                            cpe_links = cell.find_all('a', href=re.compile(r'cpe', re.I))
                            for link in cpe_links:
                                cpe_text = str(link.get_text().strip())
                                if cpe_text.startswith('cpe:'):
                                    configurations.append({
                                        'cpe': cpe_text
                                    })
        
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π NVD: {e}")
        
        return configurations
    
    def _parse_redhat_html(self, cve_id: str) -> Optional[Dict[str, Any]]:
        """
        –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏–∑ HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã Red Hat
        
        –ò–∑–≤–ª–µ–∫–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
        - CVE ID
        - –ù–∞–∑–≤–∞–Ω–∏–µ/–ó–∞–≥–æ–ª–æ–≤–æ–∫
        - –û–ø–∏—Å–∞–Ω–∏–µ
        - –£—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
        - CVSS –æ—Ü–µ–Ω–∫–∞
        - –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
        - –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        """
        try:
            url = f"{self.sources['redhat']['base_url']}/{cve_id}"
            response = self.session.get(url, timeout=30)
            response.raise_for_status()
            
            soup = BeautifulSoup(response.content, 'html.parser')
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            vulnerability_data: Dict[str, Any] = {
                'source': 'redhat',
                'cve_id': cve_id,
                'url': url,
                'parsed_from': 'html_markup'
            }
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            title_elem = soup.find('title')
            if title_elem:
                vulnerability_data['title'] = str(title_elem.get_text().strip())
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
            description = self._extract_redhat_description(soup)
            if description:
                vulnerability_data['description'] = str(description)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –∏ CVSS
            severity_info = self._extract_redhat_severity(soup)
            if severity_info:
                vulnerability_data.update(severity_info)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
            products = self._extract_redhat_products(soup)
            if products:
                vulnerability_data['affected_products'] = products
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫–∏
            links = self._extract_links(soup, url)
            if links:
                vulnerability_data['references'] = links
            
            return vulnerability_data
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ Red Hat CVE {cve_id}: {e}")
            return None
    
    def _extract_redhat_description(self, soup) -> Optional[str]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏–∑ Red Hat —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        try:
            # –ò—â–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
            desc_candidates = [
                soup.find(string=re.compile(r'Description', re.I)),
                soup.find('h2', string=re.compile(r'Description', re.I)),
                soup.find('h3', string=re.compile(r'Description', re.I))
            ]
            
            for candidate in desc_candidates:
                if candidate:
                    # –ò—â–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç
                    parent = candidate.parent if hasattr(candidate, 'parent') else candidate
                    if parent:
                        text = str(parent.get_text())
                        if len(text) > 50:
                            return text.strip()
            
            # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –ø–æ–∏—Å–∫ –≤ –æ–±—â–µ–º —Ç–µ–∫—Å—Ç–µ
            page_text = str(soup.get_text())
            desc_match = re.search(r'Description\s*:?\s*(.*?)(?:\n\n|\Z)', page_text, re.I | re.S)
            if desc_match:
                return str(desc_match.group(1).strip())
                
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è Red Hat: {e}")
        
        return None
    
    def _extract_redhat_severity(self, soup) -> Optional[Dict]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –∏ CVSS –∏–∑ Red Hat —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        severity_info = {}
        
        try:
            page_text = str(soup.get_text())
            
            # –ò—â–µ–º —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
            severity_patterns = [
                r'(Critical|Important|Moderate|Low)\s+Impact',
                r'Impact\s*:\s*(Critical|Important|Moderate|Low)',
                r'Severity\s*:\s*(Critical|High|Medium|Low)'
            ]
            
            for pattern in severity_patterns:
                severity_match = re.search(pattern, page_text, re.I)
                if severity_match:
                    severity_info['severity'] = str(severity_match.group(1).lower())
                    break
            
            # –ò—â–µ–º CVSS –æ—Ü–µ–Ω–∫—É
            cvss_match = re.search(r'CVSS\s*(\d+\.\d+)', page_text, re.I)
            if cvss_match:
                severity_info['cvss_score'] = float(cvss_match.group(1))
        
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ Red Hat: {e}")
        
        return severity_info if severity_info else None
    
    def _extract_redhat_products(self, soup) -> List[Dict]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö –∏–∑ Red Hat —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        products = []
        
        try:
            # –ò—â–µ–º —Ç–∞–±–ª–∏—Ü—ã —Å –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
            tables = soup.find_all('table')
            for table in tables:
                # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
                rows = table.find_all('tr')
                for row in rows:
                    cells = row.find_all('td')
                    if len(cells) >= 2:
                        product_info = {
                            'product': str(cells[0].get_text().strip()) if cells[0] else '',
                            'version': str(cells[1].get_text().strip()) if len(cells) > 1 else '',
                            'status': str(cells[2].get_text().strip()) if len(cells) > 2 else ''
                        }
                        if product_info['product']:
                            products.append(product_info)
        
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ Red Hat: {e}")
        
        return products
    
    def _extract_links(self, soup, base_url: str) -> List[Dict]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –∏–∑ HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        links = []
        
        try:
            # –ò—â–µ–º –≤—Å–µ —Å—Å—ã–ª–∫–∏
            link_elements = soup.find_all('a', href=True)
            for link_elem in link_elements:
                href = str(link_elem['href'])
                text = str(link_elem.get_text().strip())
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if href.startswith('/'):
                    from urllib.parse import urljoin
                    href = urljoin(base_url, href)
                elif not href.startswith(('http://', 'https://')):
                    from urllib.parse import urljoin
                    href = urljoin(base_url, href)
                
                # –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –µ—Å–ª–∏ –æ–Ω–∞ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª
                if href and len(href) > 10:
                    links.append({
                        'url': str(href),
                        'description': str(text) if text else 'External reference'
                    })
        
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Å—Å—ã–ª–æ–∫: {e}")
        
        return links
    
    def _get_selenium_driver(self):
        """–ü–æ–ª—É—á–∏—Ç—å Selenium WebDriver –¥–ª—è —Å–ª–æ–∂–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞"""
        try:
            chrome_options = Options()
            chrome_options.add_argument('--headless')
            chrome_options.add_argument('--no-sandbox')
            chrome_options.add_argument('--disable-dev-shm-usage')
            chrome_options.add_argument('--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36')
            
            driver = webdriver.Chrome(options=chrome_options)
            return driver
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Selenium WebDriver: {e}")
            return None
    
    def create_vulnerability_object(self, vuln_data: Dict) -> Vulnerability:
        """
        –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç Vulnerability –∏–∑ —Å–ø–∞—Ä—Å–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        
        Args:
            vuln_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç–∏
            
        Returns:
            Vulnerability: –û–±—ä–µ–∫—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
            description = str(vuln_data.get('description', '') or vuln_data.get('title', ''))
            if not description:
                description = f"Vulnerability from {vuln_data.get('source', 'unknown')}: {vuln_data.get('cve_id', 'Unknown')}"
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –∏ CVSS –æ—Ü–µ–Ω–∫—É
            severity = str(vuln_data.get('severity', 'medium')).lower()
            cvss_score = float(vuln_data.get('cvss_score', 0.0) or 0.0)
            
            # –ï—Å–ª–∏ –Ω–µ—Ç CVSS –æ—Ü–µ–Ω–∫–∏, –ø—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —É—Ä–æ–≤–Ω—é —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
            if cvss_score == 0.0:
                severity_cvss_map = {
                    'critical': 9.0,
                    'high': 7.5,
                    'medium': 5.0,
                    'low': 2.0,
                    'unknown': 5.0
                }
                cvss_score = severity_cvss_map.get(severity, 5.0)
            
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ CVSS –æ—Ü–µ–Ω–∫–∏
            if cvss_score > 0:
                if cvss_score >= 9.0:
                    severity = 'critical'
                elif cvss_score >= 7.0:
                    severity = 'high'
                elif cvss_score >= 4.0:
                    severity = 'medium'
                else:
                    severity = 'low'
            
            # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç Vulnerability
            vulnerability = Vulnerability(
                id=0,  # –ë–î —Å–∞–º–∞ –Ω–∞–∑–Ω–∞—á–∏—Ç ID
                title=str(vuln_data.get('cve_id', vuln_data.get('title', f"Unknown from {vuln_data.get('source', 'unknown')}"))[:200]),
                description=str(description[:1000]),
                severity=str(severity),
                status='new',
                assigned_operator=None,
                created_date=datetime.now(),
                completed_date=None,
                approved=False,
                modifications=0,
                cvss_score=cvss_score,
                risk_level=str(severity),  # –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —É—Ä–æ–≤–µ–Ω—å –¥–ª—è —Ä–∏—Å–∫–∞
                category='security'
            )
            
            # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            setattr(vulnerability, 'cve_id', str(vuln_data.get('cve_id', '')))
            setattr(vulnerability, 'source_identifier', str(vuln_data.get('source', '')))
            setattr(vulnerability, 'published', self._parse_date(vuln_data.get('published')))
            setattr(vulnerability, 'last_modified', self._parse_date(vuln_data.get('published')))  # Use published as last_modified
            setattr(vulnerability, 'vuln_status', 'new')  # Default status
            setattr(vulnerability, 'url', str(vuln_data.get('url', '')))
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–∞–∫–µ—Ç—ã/–ø—Ä–æ–¥—É–∫—Ç—ã
            affected_items = vuln_data.get('affected_packages', []) or vuln_data.get('affected_products', [])
            if affected_items:
                setattr(vulnerability, 'affected_packages', [str(item.get('name', item.get('product', ''))) for item in affected_items])
            
            # –°–æ–∑–¥–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ NVD
            descriptions = []
            if description:
                descriptions.append({'lang': 'en', 'value': str(description[:1000])})
            setattr(vulnerability, 'descriptions', descriptions)
            
            # –°–æ–∑–¥–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏
            metrics = {}
            if cvss_score > 0:
                metrics['cvss_v3'] = {
                    'version': '3.1',
                    'baseScore': cvss_score,
                    'baseSeverity': str(severity.capitalize())
                }
            setattr(vulnerability, 'metrics', metrics)
            
            # –°–æ–∑–¥–∞–µ–º —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ (CWE)
            weaknesses = []
            if vuln_data.get('cwe'):
                weaknesses.append({
                    'source': str(vuln_data.get('source', '')),
                    'type': 'Primary',
                    'description': str(vuln_data['cwe'])
                })
            setattr(vulnerability, 'weaknesses', weaknesses)
            
            # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            configurations = []
            if vuln_data.get('configurations'):
                configurations = vuln_data['configurations']
            setattr(vulnerability, 'configurations', configurations)
            
            # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫–∏
            references = []
            if vuln_data.get('references'):
                references = vuln_data['references']
            setattr(vulnerability, 'references', references)
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
            setattr(vulnerability, 'vendor_comments', [])
            setattr(vulnerability, 'is_ai_related', False)
            setattr(vulnerability, 'ai_confidence', 0.0)
            setattr(vulnerability, 'has_kev', False)
            setattr(vulnerability, 'has_cert_alerts', False)
            
            return vulnerability
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞ Vulnerability: {e}")
            raise
    
    def _parse_date(self, date_str: Optional[str]) -> Optional[datetime]:
        """–ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏"""
        if not date_str:
            return None
        
        try:
            # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç
            if 'T' in date_str:
                # ISO —Ñ–æ—Ä–º–∞—Ç
                date_str = date_str.replace('Z', '+00:00')
                return datetime.fromisoformat(date_str)
            else:
                # –ü—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD
                return datetime.strptime(date_str, '%Y-%m-%d')
        except (ValueError, TypeError):
            return None
    
    def save_vulnerabilities(self, vulnerabilities: List[Dict]) -> int:
        """
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ –ë–î
        
        Args:
            vulnerabilities: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç—è—Ö
            
        Returns:
            int: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
        """
        try:
            from models.database import DatabaseManager
            from models.postgres_repositories import PostgresVulnerabilityRepository
            
            db_manager = DatabaseManager()
            repo = PostgresVulnerabilityRepository(db_manager.connection)
            saved_count = 0
            
            for vuln_data in vulnerabilities:
                try:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —É—è–∑–≤–∏–º–æ—Å—Ç—å —Å —Ç–∞–∫–∏–º CVE ID
                    cve_id = vuln_data.get('cve_id')
                    if cve_id and self._check_cve_exists(db_manager, str(cve_id)):
                        logger.info(f"‚ö†Ô∏è –£—è–∑–≤–∏–º–æ—Å—Ç—å {cve_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î")
                        continue
                    
                    # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç Vulnerability
                    vulnerability = self.create_vulnerability_object(vuln_data)
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
                    if repo.add(vulnerability):
                        saved_count += 1
                        logger.info(f"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç—å: {vulnerability.title}")
                    else:
                        logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å: {vulnerability.title}")
                        
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ {vuln_data.get('cve_id', 'Unknown')}: {e}")
            
            return saved_count
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π: {e}")
            return 0
    
    def _check_cve_exists(self, db_manager, cve_id: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ CVE –≤ –ë–î"""
        try:
            query = "SELECT 1 FROM vulnerabilities WHERE cve_id = %s LIMIT 1"
            with db_manager.connection.cursor() as cursor:
                cursor.execute(query, (cve_id,))
                return cursor.fetchone() is not None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è CVE {cve_id}: {e}")
            return False


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–∞—Ä—Å–µ—Ä–∞
html_vulnerability_parser = HTMLVulnerabilityParser()